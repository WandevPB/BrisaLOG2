<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Consulta de Agendamento | BrisaLOG - Acompanhamento Din√¢mico</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="config.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'bg-dark': '#0D0D0D', /* Fundo principal */
                        'card-dark': '#181818', /* Fundo do card */
                        'border-dark': '#2E2E2E', /* Linhas de separa√ß√£o */
                        'orange-primary': '#FF6B35',
                        'orange-secondary': '#FF8C42',
                        'gray-light': '#EFEFEF',
                        'text-secondary': '#B0B0B0',
                        'info-bg': '#1B263B',
                        'info-text': '#85A3C7',
                    },
                    keyframes: {
                        'timeline-pulse': {
                            '0%, 100%': { transform: 'scale(1)', opacity: '0.8' },
                            '50%': { transform: 'scale(1.2)', opacity: '1' },
                        },
                        'float-3d': {
                            '0%, 100%': { transform: 'translateY(0) perspective(500px) rotateX(0deg)' },
                            '50%': { transform: 'translateY(-5px) perspective(500px) rotateX(2deg)' },
                        },
                    },
                    animation: {
                        'timeline-pulse': 'timeline-pulse 2s ease-in-out infinite',
                        'float-3d': 'float-3d 5s ease-in-out infinite',
                    },
                    boxShadow: {
                        'deep': '0 10px 30px rgba(0, 0, 0, 0.6), 0 0 10px rgba(255, 107, 53, 0.1)',
                        'card-hover': '0 8px 30px rgba(255, 107, 53, 0.15)',
                    }
                }
            }
        }
    </script>

    <style>
        /* Estilos de tema */
        body {
            font-family: 'Inter', sans-serif;
            background: #0D0D0D; 
            color: #EFEFEF;
            min-height: 100vh;
        }
        .navbar {
            background: rgba(20,20,20,0.98);
            backdrop-filter: blur(5px);
            border-bottom: 1px solid #FF6B35;
            position: sticky;
            top: 0;
            z-index: 50;
            box-shadow: 0 4px 15px rgba(0,0,0,0.5);
        }
        .card-detail {
            background: #181818; 
            border: 1px solid #2E2E2E;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 4px 15px rgba(0,0,0,0.4);
        }
        .card-detail:hover {
            border-color: #FF6B35;
            box-shadow: 0 8px 30px rgba(255, 107, 53, 0.15);
            transform: translateY(-3px);
        }
        .modal-backdrop {
            background: rgba(0,0,0,0.7);
        }
        
        /* Cores de Status */
        .status-pendente { background-color: #FF8C42; color: #fff; }
        .status-confirmado, .status-entregue { background-color: #10B981; color: #fff; }
        .status-reagendamento, .status-aguardando_resposta_cd { background-color: #FBBF24; color: #333; }
        .status-nao-veio, .status-cancelado { background-color: #EF4444; color: #fff; } 
        
        /* Timeline 3D */
        .timeline-container {
            position: relative;
            background: linear-gradient(145deg, #181818, #101010);
            border: 2px solid #2E2E2E;
            box-shadow: inset 0 0 20px rgba(0,0,0,0.5);
        }
        .timeline-path-fill {
            transition: width 1.5s ease-in-out;
            background: linear-gradient(90deg, #FF6B35 0%, #FF8C42 100%);
            box-shadow: 0 0 10px #FF6B35;
        }
        .timeline-truck {
            position: absolute;
            top: 50%;
            transition: left 1.5s ease-in-out;
            z-index: 10;
        }
        .truck-icon {
            filter: drop-shadow(0 0 5px #FF6B35);
        }
        /* Estilo para inputs em dark mode */
        input:not(.timeline-input), textarea, select {
            background-color: #2D2D2D !important;
            border-color: #444444 !important;
            color: #EFEFEF !important;
        }
        /* Estilo para hist√≥rico de eventos */
        .event-detail-card {
            background: #1F1F1F;
            border-left: 3px solid;
            transition: all 0.3s;
        }
        .event-detail-card:hover {
            background: #252525;
            transform: translateX(3px);
        }
    </style>
</head>
<body>

    <!-- NAV BAR -->
    <nav class="navbar flex items-center justify-between px-8 py-4">
        <div class="flex items-center gap-3">
            <a href="index.html" class="w-10 h-10 bg-gradient-to-br from-orange-500 to-orange-600 rounded-lg flex items-center justify-center">
                <i class="fas fa-truck-fast text-white text-xl"></i>
            </a>
            <span class="font-bold text-xl text-white">BrisaLOG Agenda</span>
        </div>
        <div class="flex gap-4 items-center">
            <a href="index.html" class="text-text-secondary hover:text-white transition-colors"><i class="fas fa-arrow-left mr-2"></i>Voltar ao In√≠cio</a>
            <button onclick="openConsultaModal()" class="bg-orange-primary hover:bg-orange-secondary text-white font-semibold py-2 px-4 rounded-lg transition-colors"><i class="fas fa-search mr-2"></i>Consultar outro</button>
        </div>
    </nav>
    
    <!-- MAIN CONTENT -->
    <main class="max-w-7xl mx-auto px-4 py-12">
        <header class="text-center mb-10">
            <h1 class="text-5xl font-black text-white mb-2 tracking-tight">
                STATUS DO AGENDAMENTO <span id="display-codigo" class="text-orange-primary font-mono">...</span>
            </h1>
            <p class="text-xl text-text-secondary">Vis√£o em tempo real do seu fluxo log√≠stico na BrisaNET.</p>
        </header>

        <!-- CONTAINER PRINCIPAL DOS DETALHES -->
        <div id="agendamento-detalhes">
            <div class="text-center p-10 bg-card-dark rounded-2xl shadow-deep">
                <i class="fas fa-route text-6xl text-orange-primary mb-4 animate-float"></i>
                <p class="text-xl text-text-secondary"><i class="fas fa-spinner fa-spin mr-2"></i>Carregando detalhes...</p>
            </div>
            <!-- CONTE√öDO DIN√ÇMICO SER√Å INJETADO AQUI PELO JS -->
        </div>

    </main>

    <!-- FOOTER -->
    <footer class="text-center py-6 text-text-secondary border-t border-border-dark mt-12">
        <p class="text-sm">&copy; 2025 BrisaNET Log√≠stica. Desenvolvido por Wanderson Davyd. Todos os direitos reservados.</p>
    </footer>


    <!-- ########################### MODAIS DE A√á√ÉO ########################### -->

    <!-- 1. Modal de Consulta (Gateway de entrada) -->
    <div id="consulta-modal" class="hidden fixed inset-0 modal-backdrop z-[100] flex items-center justify-center">
        <div class="bg-card-dark rounded-2xl max-w-md w-full mx-4 border border-border-dark shadow-deep">
            <div class="p-6">
                <div class="text-center mb-6">
                    <div class="bg-gradient-to-r from-orange-primary to-orange-secondary p-4 rounded-2xl inline-block mb-4">
                        <i class="fas fa-search text-white text-2xl"></i>
                    </div>
                    <h2 class="text-2xl font-bold text-white mb-2">Consultar Agendamento</h2>
                    <p class="text-text-secondary">Digite o c√≥digo do seu agendamento</p>
                </div>
                <form id="consulta-form" class="space-y-4">
                    <div>
                        <label class="block text-white font-semibold mb-2">C√≥digo do Agendamento</label>
                        <input type="text" id="codigo-consulta" required class="w-full px-4 py-3 border border-border-dark rounded-lg bg-bg-dark text-white focus:border-orange-primary focus:ring-2 focus:ring-orange-primary focus:ring-opacity-20 transition-all" placeholder="AGD123456">
                    </div>
                    <div class="flex justify-end space-x-4 mt-6">
                        <button type="button" onclick="closeConsultaModal()" class="bg-gray-700 text-white px-6 py-2 rounded-lg hover:bg-gray-600 transition-all">Cancelar</button>
                        <button type="submit" class="bg-orange-primary hover:bg-orange-secondary text-white font-semibold py-2 px-4 rounded-lg transition-colors"><i class="fas fa-search mr-2"></i>Consultar</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- 2. Modal de Reagendamento/Contra Proposta (funcionalidade completa do c√≥digo original) -->
    <div id="contra-proposta-modal" class="fixed inset-0 bg-black bg-opacity-70 hidden z-[110] modal-backdrop">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-card-dark rounded-xl max-w-md w-full border border-border-dark shadow-deep">
                <div class="p-6 border-b border-border-dark">
                    <div class="flex justify-between items-center">
                        <h2 class="text-xl font-bold text-white">
                            <i class="fas fa-calendar-alt mr-2 text-blue-400"></i>
                            <span id="modal-reagendar-titulo">Sugerir Nova Data</span>
                        </h2>
                        <button type="button" onclick="fecharContraPropostaModal()" class="text-text-secondary hover:text-white text-xl">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <p class="text-text-secondary mt-2" id="modal-reagendar-descricao">Selecione a nova data para o seu agendamento.</p>
                </div>
                
                <div class="p-6">
                    <form id="contra-proposta-form">
                        <div class="space-y-4">
                            <div>
                                <label for="contra-proposta-data" class="block text-sm font-medium text-white mb-1">Nova Data *</label>
                                <input type="date" id="contra-proposta-data" name="novaData" required 
                                    class="w-full px-3 py-2 border rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            </div>
                            
                            <div>
                                <label for="contra-proposta-horario" class="block text-sm font-medium text-white mb-1">Novo Hor√°rio *</label>
                                <select id="contra-proposta-horario" name="novoHorario" required 
                                    class="w-full px-3 py-2 border rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                    <option value="">Selecione o hor√°rio</option>
                                    <option value="08:00-12:00">08:00 √†s 12:00</option>
                                    <option value="13:00-17:00">13:00 √†s 17:00</option>
                                    <option value="08:00-17:00">08:00 √†s 17:00 (Dia Inteiro)</option>
                                </select>
                            </div>
                            
                            <div>
                                <label for="contra-proposta-comentario" class="block text-sm font-medium text-white mb-1">Coment√°rio (opcional)</label>
                                <textarea id="contra-proposta-comentario" name="comentario" rows="3" placeholder="Explique o motivo da nova data sugerida..."
                                    class="w-full px-3 py-2 border rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500"></textarea>
                            </div>
                        </div>
                        
                        <div class="flex gap-3 mt-6">
                            <button type="submit" class="flex-1 bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700 transition-all font-medium">
                                <i class="fas fa-paper-plane mr-2"></i>Enviar Proposta
                            </button>
                            <button type="button" onclick="fecharContraPropostaModal()" class="px-4 py-2 border border-gray-600 text-text-secondary rounded-md hover:bg-gray-700 transition-all">
                                Cancelar
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- 3. Modal de Confirma√ß√£o de Cancelamento (funcionalidade completa do c√≥digo original) -->
    <div id="cancelar-solicitacao-modal" class="hidden fixed inset-0 modal-backdrop z-[110] flex items-center justify-center">
        <div class="bg-card-dark rounded-xl shadow-deep p-8 w-full max-w-md border border-red-600">
            <h2 class="text-xl font-bold mb-4 text-red-500"><i class="fas fa-exclamation-triangle mr-2"></i>Confirma√ß√£o de Cancelamento</h2>
            <p class="text-text-secondary mb-4">Se voc√™ cancelar esta solicita√ß√£o, todos os dados ser√£o permanentemente removidos. Por favor, confirme o motivo.</p>
            <form id="form-cancelar-solicitacao">
                <label for="motivo-cancelamento" class="block text-sm font-medium text-white mb-2">Motivo do cancelamento:</label>
                <textarea id="motivo-cancelamento" name="motivo" rows="3" required class="w-full border border-border-dark rounded-lg p-2 mb-4 bg-bg-dark"></textarea>
                <div class="flex justify-end gap-2">
                    <button type="button" onclick="fecharCancelarSolicitacaoModal()" class="bg-gray-700 text-white px-4 py-2 rounded-lg hover:bg-gray-600">Voltar</button>
                    <button type="submit" class="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700">Confirmar Cancelamento</button>
                </div>
            </form>
        </div>
    </div>

    <!-- 4. Container para Notifica√ß√µes -->
    <div id="notification-container" class="fixed top-5 right-5 space-y-2 z-[150]"></div>


    <!-- JAVASCRIPT L√ìGICA COMPLETA -->
    <script>
        // --- Configura√ß√µes & Vari√°veis Globais ---
        // API_BASE_URL j√° definido em config.js
        let currentAgendamento = null;
        let currentCodigoReagendamento = null;

        const statusMap = {
            'pendente': { text: 'Aguardando Confirma√ß√£o', icon: 'fa-clock', color: 'status-pendente', step: 1, progress: 20, description: 'Sua solicita√ß√£o foi recebida e est√° na fila de aprova√ß√£o do CD.' },
            'confirmado': { text: 'Agendamento Confirmado', icon: 'fa-calendar-check', color: 'status-confirmado', step: 2, progress: 45, description: 'A data e hor√°rio foram confirmados. Aguardamos sua chegada.' },
            'em_transito': { text: 'Em Tr√¢nsito/Check-in', icon: 'fa-truck-fast', color: 'status-confirmado', step: 3, progress: 70, description: 'O transporte est√° a caminho ou j√° est√° na √°rea de check-in.' },
            'entregue': { text: 'Entrega Conclu√≠da', icon: 'fa-box-open', color: 'status-confirmado', step: 4, progress: 100, description: 'A entrega foi realizada com sucesso.' },
            'reagendamento': { text: 'Reagendar (Aguardando Resposta)', icon: 'fa-sync-alt', color: 'status-reagendamento', step: 2.5, progress: 35, description: 'O CD sugeriu uma nova data/hor√°rio. Sua resposta √© necess√°ria.' },
            'nao-veio': { text: 'N√£o Compareceu (Reagendar)', icon: 'fa-user-slash', color: 'status-nao-veio', step: 2.5, progress: 35, description: 'O transportador n√£o compareceu na data agendada. Por favor, reagende.' },
            'cancelado': { text: 'Cancelado', icon: 'fa-ban', color: 'status-cancelado', step: 0, progress: 0, description: 'O agendamento foi cancelado.' },
            'aguardando_resposta_cd': { text: 'Proposta Enviada (Aguarde CD)', icon: 'fa-reply-all', color: 'status-pendente', step: 1.5, progress: 30, description: 'Sua contraproposta foi enviada. O CD est√° analisando.' }
        };

        const timelineStepsData = [
            { label: 'Cria√ß√£o', position: 0, icon: 'fa-file-signature' },
            { label: 'Confirma√ß√£o', position: 33, icon: 'fa-calendar-check' },
            { label: 'No CD', position: 66, icon: 'fa-warehouse' },
            { label: 'Conclu√≠do', position: 100, icon: 'fa-check-double' }
        ];

        // --- Fun√ß√µes de Utilit√°rio (Reincorporadas) ---

        function formatDateBrFromISO(isoString) {
            if (!isoString) return 'N/A';
            try {
                const dateStr = isoString.slice(0, 10);
                const [year, month, day] = dateStr.split('-');
                return `${day}/${month}/${year}`;
            } catch (e) {
                return 'Data Inv√°lida';
            }
        }
        function showNotification(message, type = 'info') {
            const colors = { success: 'bg-green-600', error: 'bg-red-600', warning: 'bg-yellow-500', info: 'bg-blue-600' };
            const icons = { success: 'fa-check-circle', error: 'fa-exclamation-circle', warning: 'fa-exclamation-triangle', info: 'fa-info-circle' };
            
            const notification = document.createElement('div');
            notification.className = `px-6 py-4 rounded-lg shadow-xl flex items-center space-x-3 transition-opacity duration-300 ${colors[type]} text-white`;
            notification.innerHTML = `<i class="fas ${icons[type]}"></i><span>${message}</span><button onclick="this.parentElement.remove()" class="ml-4 hover:bg-white hover:bg-opacity-20 rounded p-1"><i class="fas fa-times"></i></button>`;
            
            document.getElementById('notification-container').prepend(notification);
            setTimeout(() => { notification.style.opacity = 0; setTimeout(() => notification.remove(), 300); }, 5000);
        }
        function calcularValorTotal(agendamento) {
            const allNFs = [];
            if (agendamento.pedidos && agendamento.pedidos.length > 0) {
                agendamento.pedidos.forEach(p => p.notasFiscais?.forEach(nf => allNFs.push(nf)));
            } else if (agendamento.notasFiscais) {
                agendamento.notasFiscais.forEach(nf => allNFs.push(nf));
            }
            if (allNFs.length === 0) return '0,00';
            let total = 0;
            allNFs.forEach(nf => {
                let valorStr = String(nf.valor || '0').replace(/\./g, '').replace(',', '.');
                total += parseFloat(valorStr) || 0;
            });
            return total.toLocaleString('pt-BR', {minimumFractionDigits: 2});
        }
        function viewPDF(arquivo) {
            if (!arquivo) {
                showNotification('Arquivo PDF n√£o dispon√≠vel.', 'error');
                return;
            }
            window.open(`${API_BASE_URL}/api/files/${arquivo}`, '_blank');
        }

        // --- Fun√ß√µes de Modal e A√ß√£o (Reincorporadas) ---

        function openConsultaModal() { document.getElementById('consulta-modal').classList.remove('hidden'); }
        function closeConsultaModal() { document.getElementById('consulta-modal').classList.add('hidden'); }
        function abrirCancelarSolicitacaoModal(codigo) { 
            currentCodigoReagendamento = codigo; 
            document.getElementById('form-cancelar-solicitacao').onsubmit = (e) => {
                e.preventDefault();
                enviarMotivoCancelamento(e);
            };
            document.getElementById('cancelar-solicitacao-modal').classList.remove('hidden'); 
        }
        function fecharCancelarSolicitacaoModal() { document.getElementById('cancelar-solicitacao-modal').classList.add('hidden'); document.getElementById('motivo-cancelamento').value = ''; }
        function abrirContraProposta(codigo) {
            currentCodigoReagendamento = codigo;
            const isNaoVeio = currentAgendamento?.status === 'nao-veio';
            document.getElementById('modal-reagendar-titulo').textContent = isNaoVeio ? 'Reagendar Entrega' : 'Sugerir Nova Data';
            document.getElementById('modal-reagendar-descricao').textContent = isNaoVeio ? 'Escolha uma nova data e hor√°rio para realizar a entrega.' : 'Sugira uma nova data e hor√°rio para a equipe do CD.';
            document.getElementById('contra-proposta-form').onsubmit = (e) => {
                e.preventDefault();
                enviarContraProposta(e);
            };
            // Carregar hor√°rios dispon√≠veis dinamicamente
            const horarioSelect = document.getElementById('contra-proposta-horario');
            horarioSelect.innerHTML = '<option value="">Carregando hor√°rios...</option>';
            fetch(`${API_BASE_URL}/api/agendamentos/${codigo}/horarios-disponiveis`)
                .then(res => res.json())
                .then(result => {
                    if (result.success && Array.isArray(result.horarios)) {
                        horarioSelect.innerHTML = '<option value="">Selecione o hor√°rio</option>' + result.horarios.map(h => `<option value="${h}">${h}</option>`).join('');
                    } else {
                        horarioSelect.innerHTML = '<option value="">08:00 √†s 12:00</option><option value="13:00-17:00">13:00 √†s 17:00</option><option value="08:00-17:00">08:00 √†s 17:00 (Dia Inteiro)</option>';
                    }
                })
                .catch(() => {
                    horarioSelect.innerHTML = '<option value="">08:00 √†s 12:00</option><option value="13:00-17:00">13:00 √†s 17:00</option><option value="08:00-17:00">08:00 √†s 17:00 (Dia Inteiro)</option>';
                });
            document.getElementById('contra-proposta-modal').classList.remove('hidden');
        }
        function fecharContraPropostaModal() { document.getElementById('contra-proposta-modal').classList.add('hidden'); currentCodigoReagendamento = null; }
        
        async function responderReagendamento(codigo, resposta) {
            if (!confirm(`Tem certeza que deseja ${resposta === 'aceito' ? 'ACEITAR' : 'REJEITAR'} esta sugest√£o de reagendamento?`)) return;
            try {
                const response = await fetch(`${API_BASE_URL}/api/agendamentos/${codigo}/responder-reagendamento`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ resposta: resposta, comentario: '' }) });
                const result = await response.json();
                if (result.success) {
                    showNotification(`Reagendamento ${resposta === 'aceito' ? 'ACEITO' : 'REJEITADO'} com sucesso!`, 'success');
                    await fetchAgendamentoAndRender(codigo); 
                } else { showNotification(result.error || 'Erro ao responder reagendamento.', 'error'); }
            } catch (error) { showNotification('Erro de conex√£o ao responder reagendamento.', 'error'); }
        }
        async function enviarMotivoCancelamento(event) {
            event.preventDefault();
            const codigo = currentCodigoReagendamento;
            const motivo = document.getElementById('motivo-cancelamento').value.trim();
            if (!motivo) { showNotification('Informe o motivo do cancelamento.', 'error'); return; }
            try {
                const response = await fetch(`${API_BASE_URL}/api/agendamentos/${codigo}/cancelar`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ motivo: motivo }) });
                const result = await response.json();
                if (result.success) {
                    fecharCancelarSolicitacaoModal();
                    showNotification('Solicita√ß√£o de cancelamento enviada!', 'success');
                    await fetchAgendamentoAndRender(codigo);
                } else { showNotification(result.message || 'Erro ao cancelar solicita√ß√£o.', 'error'); }
            } catch (error) { showNotification('Erro de conex√£o ao cancelar solicita√ß√£o.', 'error'); }
        }
        async function enviarContraProposta(event) {
            event.preventDefault();
            const codigo = currentCodigoReagendamento;
            const { value: novaData } = document.getElementById('contra-proposta-data');
            const { value: novoHorario } = document.getElementById('contra-proposta-horario');
            const { value: comentario } = document.getElementById('contra-proposta-comentario');
            if (!novaData || !novoHorario) { showNotification('Preencha a data e hor√°rio.', 'error'); return; }

            const isNaoVeio = currentAgendamento?.status === 'nao-veio';
            let apiUrl = isNaoVeio ? `${API_BASE_URL}/api/agendamentos/${codigo}/reagendar-Transportador` : `${API_BASE_URL}/api/agendamentos/${codigo}/responder-reagendamento`;
            let requestBody = isNaoVeio ? { novaData, novoHorario, motivo: comentario } : { resposta: 'contra_proposta', comentario, novaData, novoHorario };
            
            try {
                const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(requestBody) });
                const result = await response.json();
                if (result.success) {
                    showNotification('Proposta de data enviada com sucesso!', 'success');
                    fecharContraPropostaModal();
                    await fetchAgendamentoAndRender(codigo);
                } else { showNotification(result.error || result.message || 'Erro ao enviar proposta.', 'error'); }
            } catch (error) { showNotification('Erro de conex√£o ao enviar proposta.', 'error'); }
        }

        // --- Fun√ß√µes de Renderiza√ß√£o e Anima√ß√£o ---

        function renderTimeline(currentStatus) {
            const statusInfo = statusMap[currentStatus];
            const truckIcon = statusInfo?.icon || 'fa-truck';
            // Timeline din√¢mica: cada status vira um ponto
            const timelineStatuses = [
                { key: 'pendente', label: 'Aguardando Confirma√ß√£o', icon: 'fa-clock' },
                { key: 'confirmado', label: 'Confirmado (Aguardando entrega do material no CD)', icon: 'fa-calendar-check' },
                { key: 'reagendamento_cd', label: 'Reagendamento (aguardando confirma√ß√£o do Transportador)', icon: 'fa-sync-alt' },
                { key: 'reagendamento_transportador', label: 'Reagendamento (aguardando confirma√ß√£o do CD)', icon: 'fa-reply-all' },
                { key: 'em_transito', label: 'Em Tr√¢nsito', icon: 'fa-truck-fast' },
                { key: 'entregue', label: 'Entregue', icon: 'fa-box-open' }
            ];
            // Mapeamento do status para o ponto correto
            let statusMapIdx = {
                'pendente': 0,
                'confirmado': 1,
                'reagendamento': 2, // CD sugeriu reagendamento
                'aguardando_resposta_cd': 3, // Transportador sugeriu reagendamento
                'nao-veio': 3, // Transportador n√£o veio, fica aguardando confirma√ß√£o do Transportador
                'em_transito': 4,
                'entregue': 5
            };
            let currentIdx = statusMapIdx[currentStatus] ?? 0;
            let stepsHTML = '';
            timelineStatuses.forEach((step, idx) => {
                const isCompleted = idx < currentIdx;
                const isActive = idx === currentIdx;
                stepsHTML += `
                    <div class="flex flex-col items-center min-w-[140px] mx-2">
                        <div class="timeline-step-icon text-white w-10 h-10 rounded-full flex items-center justify-center shadow-lg ${isCompleted ? 'bg-green-500' : (isActive ? 'bg-orange-primary animate-timeline-pulse ring-4 ring-orange-secondary' : 'bg-gray-700')}">
                            <i class="fas ${step.icon} text-xl"></i>
                        </div>
                        <p class="timeline-label text-text-secondary text-xs mt-2 text-center font-bold">${step.label}</p>
                    </div>
                `;
            });
            // Caminh√£o 3D super din√¢mico - agora acima dos pontos
            const truckLeft = (currentIdx * 140) + 40;
            const truck3D = `
                <div id="timeline-truck" class="absolute -top-10" style="left:${truckLeft}px;transition:left 1s;z-index:10;">
                    <div style="perspective: 800px;">
                        <i class="fas fa-truck-fast text-6xl text-orange-primary truck-icon" style="animation: float-3d 2s cubic-bezier(.4,0,.2,1) infinite, timeline-pulse 1.5s infinite alternate;"></i>
                        <div class="w-20 h-2 bg-gradient-to-r from-orange-primary to-orange-secondary rounded-full mt-2 mx-auto animate-pulse"></div>
                    </div>
                </div>
            `;
            const timelineHTML = `
                <div class="timeline-container rounded-2xl p-8 mb-10 overflow-x-auto shadow-deep">
                    <h3 class="text-2xl font-extrabold text-white mb-8 flex items-center gap-3">
                        <i class="fas ${statusInfo.icon} text-orange-primary"></i>
                        Fluxo Log√≠stico: <span class="font-bold ${statusInfo.color} px-3 py-1 rounded-lg">${statusInfo.text}</span>
                    </h3>
                    <p class="text-text-secondary mb-8 text-center">${statusInfo.description}</p>
                    <div class="relative h-40 w-full mb-10 overflow-x-auto">
                        <div class="flex items-center h-32 relative" style="min-width:${timelineStatuses.length * 140}px;">
                            ${truck3D}
                            ${stepsHTML}
                        </div>
                    </div>
                </div>
            `;
            return timelineHTML;
        }

        function renderActionButtons(data) {
            let buttons = '';
            
            if (data.status === 'reagendamento') {
                buttons += `
                    <p class="text-lg font-semibold text-yellow-400">Nova data sugerida pelo CD: ${formatDateBrFromISO(data.dataSugestaoCD)} √†s ${data.horarioSugestaoCD}</p>
                    <button onclick="responderReagendamento('${data.codigo}', 'aceito')" class="bg-green-600 hover:bg-green-700 text-white font-semibold py-3 px-6 rounded-lg transition-colors flex items-center"><i class="fas fa-check mr-2"></i>Aceitar Nova Data</button>
                    <button onclick="abrirContraProposta('${data.codigo}')" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-6 rounded-lg transition-colors flex items-center"><i class="fas fa-calendar-plus mr-2"></i>Sugerir Outra Data</button>
                    <button onclick="abrirCancelarSolicitacaoModal('${data.codigo}')" class="bg-red-600 hover:bg-red-700 text-white font-semibold py-3 px-6 rounded-lg transition-colors flex items-center"><i class="fas fa-times-circle mr-2"></i>Cancelar Solicita√ß√£o</button>
                `;
            } 
            else if (data.status === 'nao-veio') {
                buttons += `
                    <p class="text-lg font-semibold text-red-400">üö® √â necess√°rio reagendar a entrega!</p>
                    <button onclick="abrirContraProposta('${data.codigo}')" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-6 rounded-lg transition-colors flex items-center"><i class="fas fa-redo mr-2"></i>Reagendar Entrega</button>
                    <button onclick="abrirCancelarSolicitacaoModal('${data.codigo}')" class="bg-red-600 hover:bg-red-700 text-white font-semibold py-3 px-6 rounded-lg transition-colors flex items-center"><i class="fas fa-times-circle mr-2"></i>Cancelar Agendamento</button>
                `;
            }
            else if (data.status === 'pendente' || data.status === 'confirmado' || data.status === 'aguardando_resposta_cd' || data.status === 'em_transito') {
                 buttons += `
                    <p class="text-lg font-semibold text-text-secondary"><i class="fas fa-lock mr-2 text-green-400"></i>Agendamento Ativo. Para alterar, solicite o cancelamento.</p>
                    <button onclick="abrirCancelarSolicitacaoModal('${data.codigo}')" class="bg-red-600 hover:bg-red-700 text-white font-semibold py-3 px-6 rounded-lg transition-colors flex items-center"><i class="fas fa-times-circle mr-2"></i>Cancelar Solicita√ß√£o</button>
                `;
            }
            else if (data.status === 'entregue' || data.status === 'cancelado') {
                buttons += `<p class="text-lg font-semibold text-green-400"><i class="fas fa-bookmark mr-2"></i>Este agendamento est√° finalizado. Nenhuma a√ß√£o necess√°ria.</p>`;
            }

            return buttons;
        }

        function getHistoryStyle(acao) {
            const styles = {
                'agendamento_criado': { icon: 'fa-plus-circle', color: 'border-blue-500', title: 'Agendamento Criado' },
                'cd_sugeriu_reagendamento': { icon: 'fa-calendar-alt', color: 'border-yellow-500', title: 'Nova Data Sugerida (CD)' },
                'Transportador_sugeriu_reagendamento': { icon: 'fa-reply-all', color: 'border-blue-400', title: 'Contra Proposta Enviada' },
                'Transportador_aceitou_reagendamento': { icon: 'fa-check-double', color: 'border-green-500', title: 'Nova Data Aceita' },
                'Transportador_rejeitou_reagendamento': { icon: 'fa-thumbs-down', color: 'border-red-500', title: 'Proposta Rejeitada' },
                'entrega_realizada': { icon: 'fa-box-open', color: 'border-green-600', title: 'Entrega Conclu√≠da' },
                'ausencia_registrada': { icon: 'fa-user-slash', color: 'border-red-500', title: 'Aus√™ncia Registrada' },
                'cancelado_Transportador': { icon: 'fa-ban', color: 'border-red-500', title: 'Solicita√ß√£o Cancelada' },
                'confirmado': { icon: 'fa-check-circle', color: 'border-green-500', title: 'Agendamento Confirmado' }
            };
            return styles[acao] || { icon: 'fa-info-circle', color: 'border-gray-500', title: 'Evento do Sistema' };
        }

        function renderCommunicationHistory(data) {
            const historico = data.historico || [];
            if (historico.length === 0) {
                return '<div class="text-center py-4 text-text-secondary">Nenhum evento registrado.</div>';
            }

            return `
                <div class="space-y-4">
                    ${historico.reverse().map(evento => { 
                        const style = getHistoryStyle(evento.acao);
                        const dataFormatada = evento.data ? new Date(evento.data).toLocaleString('pt-BR', { dateStyle: 'short', timeStyle: 'short' }) : 'Agora';
                        
                        return `
                            <div class="event-detail-card p-4 rounded-lg shadow-sm border-l-4 ${style.color}">
                                <div class="flex items-center justify-between mb-2">
                                    <p class="font-semibold text-white flex items-center gap-2">
                                        <i class="fas ${style.icon} text-orange-primary text-sm"></i> ${style.title}
                                    </p>
                                    <span class="text-xs text-text-secondary">${dataFormatada}</span>
                                </div>
                                <p class="text-sm text-text-secondary leading-relaxed">
                                    ${evento.descricao || 'Detalhes n√£o informados.'}
                                </p>
                                ${(evento.novaData || evento.novoHorario) ? `
                                    <div class="mt-2 text-xs text-blue-400 font-medium">
                                        <i class="fas fa-calendar-day mr-1"></i> ${formatDateBrFromISO(evento.novaData) || 'N/A'} - ${evento.novoHorario || 'N/A'}
                                    </div>
                                ` : ''}
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
        }

        function renderPedidosENotasFiscais(data) {
            const allPedidos = {}; 
            
            if (data.pedidos && data.pedidos.length > 0) {
                data.pedidos.forEach(p => {
                    allPedidos[p.numero] = {
                        numero: p.numero,
                        notasFiscais: p.notasFiscais || []
                    };
                });
            } else if (data.notasFiscais) {
                 data.notasFiscais.forEach(nf => {
                    const pedidoNum = nf.numeroPedido || 'N/A';
                    if (!allPedidos[pedidoNum]) {
                        allPedidos[pedidoNum] = { numero: pedidoNum, notasFiscais: [] };
                    }
                    allPedidos[pedidoNum].notasFiscais.push(nf);
                 });
            }

            const pedidosArray = Object.values(allPedidos).filter(p => p.notasFiscais.length > 0);

            if (pedidosArray.length === 0) {
                return '<div class="text-center py-4 text-text-secondary">Nenhum Pedido ou Nota Fiscal vinculada.</div>';
            }

            let html = ``;

            pedidosArray.forEach(pedido => {
                html += `
                    <div class="bg-gray-800 p-4 rounded-xl border border-border-dark mb-4">
                        <h4 class="font-bold text-lg text-white mb-3 flex items-center gap-2 border-b border-border-dark/50 pb-2">
                            <i class="fas fa-tag text-orange-400"></i> Pedido: ${pedido.numero || 'N/A'}
                            <span class="text-xs ml-auto text-text-secondary">NFs no Pedido: ${pedido.notasFiscais.length}</span>
                        </h4>
                        <div class="space-y-3 pt-2">
                            ${pedido.notasFiscais.map(nf => {
                                const nfValor = calcularValorNF(nf.valor || '0');
                                const fileButton = nf.arquivo ? 
                                    `<button onclick="viewPDF('${nf.arquivo}')" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded text-xs transition-colors"><i class="fas fa-file-pdf mr-1"></i>PDF</button>` : '';

                                return `
                                    <div class="flex justify-between items-center bg-gray-900 p-3 rounded-lg border border-gray-700">
                                        <div class="flex flex-col">
                                            <span class="font-semibold text-white text-sm">NF: ${nf.numero || 'N/A'}</span>
                                            <span class="text-xs text-text-secondary">S√©rie: ${nf.serie || 'N/A'}</span>
                                        </div>
                                        <div class="flex items-center gap-4">
                                            <span class="text-green-400 font-extrabold text-sm">R$ ${nfValor}</span>
                                            ${fileButton}
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                `;
            });
            
            return html;
        }

        function calcularValorNF(valorStr) {
            let cleanStr = String(valorStr).replace(/\./g, ''); // Remove pontos de milhar
            cleanStr = cleanStr.replace(',', '.'); // Troca v√≠rgula por ponto decimal
            const v = parseFloat(cleanStr) || 0;
            return v.toLocaleString('pt-BR', {minimumFractionDigits: 2});
        }
        
        function renderAgendamentoDetalhes(data) {
            currentAgendamento = data;
            document.getElementById('display-codigo').textContent = data.codigo || 'N/A';
            document.getElementById('display-codigo').classList.remove('animate-pulse');

            const statusSectionHTML = renderTimeline(data.status);
            const buttonsHTML = renderActionButtons(data);
            const communicationHistoryHTML = renderCommunicationHistory(data);
            const nfsHTML = renderPedidosENotasFiscais(data);

            const detailsHTML = `
                <div class="space-y-8">
                    
                    ${statusSectionHTML}

                    <!-- A√á√ïES CONDICIONAIS -->
                    <div class="card-detail p-6 rounded-2xl flex flex-wrap gap-4 items-center justify-center border-orange-primary/30">
                        ${buttonsHTML}
                    </div>
                    
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <!-- COLUNA 1: DADOS PRINCIPAIS -->
                        <div class="lg:col-span-1 h-full flex flex-col justify-between">
                            <div class="card-detail p-6 rounded-xl h-full flex flex-col justify-between">
                                <h3 class="text-xl font-bold text-white mb-4 flex items-center gap-2 border-b border-border-dark/50 pb-3">
                                    <i class="fas fa-calendar-alt text-orange-primary"></i> Agendamento & CD
                                </h3>
                                <div class="space-y-3 text-sm flex-1">
                                    <div><span class="text-text-secondary block">Data Solicitada:</span> <span class="font-semibold text-gray-light">${formatDateBrFromISO(data.dataEntrega)}</span></div>
                                    <div><span class="text-text-secondary block">Hor√°rio:</span> <span class="font-semibold text-gray-light">${data.horarioEntrega}</span></div>
                                    <div><span class="text-text-secondary block">CD Destino:</span> <span class="font-extrabold text-orange-secondary">${data.cdDestino || 'N/A'}</span></div>
                                    <div><span class="text-text-secondary block">Cria√ß√£o:</span> <span class="font-semibold text-gray-light">${formatDateBrFromISO(data.dataCriacao)}</span></div>
                                </div>
                            </div>
                        </div>
                        <!-- COLUNA 2: DADOS DO TRANSPORTADOR -->
                        <div class="lg:col-span-1 h-full flex flex-col justify-between">
                            <div class="card-detail p-6 rounded-xl h-full flex flex-col justify-between">
                                <h3 class="text-xl font-bold text-white mb-4 flex items-center gap-2 border-b border-border-dark/50 pb-3">
                                    <i class="fas fa-truck-moving text-blue-400"></i> Transportador
                                </h3>
                                <div class="space-y-3 text-sm flex-1">
                                    <div><span class="text-text-secondary block">Empresa:</span> <span class="font-semibold text-gray-light">${data.fornecedor?.nome || 'N/A'}</span></div>
                                    <div><span class="text-text-secondary block">CNPJ:</span> <span class="font-semibold text-gray-light">${data.fornecedor?.documento || 'N/A'}</span></div>
                                    <div><span class="text-text-secondary block">Contato:</span> <span class="font-semibold text-gray-light truncate" title="${data.fornecedor?.email || 'N/A'}">${data.fornecedor?.email || 'N/A'}</span></div>
                                    <div class="border-t border-border-dark/50 pt-3 mt-3">
                                        <p class="font-semibold text-orange-400 mb-1">Motorista & Ve√≠culo</p>
                                        <div><span class="text-text-secondary block">Motorista:</span> <span class="font-semibold text-gray-light">${data.motoristaNome || 'N/A'}</span></div>
                                        <div><span class="text-text-secondary block">Placa / Tipo:</span> <span class="font-bold text-orange-secondary">${data.placaVeiculo || 'N/A'} / ${data.tipoVeiculo || 'N/A'}</span></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <!-- COLUNA 3: RESUMO GERAL -->
                        <div class="lg:col-span-1 h-full flex flex-col justify-between">
                            <div class="card-detail p-6 rounded-xl h-full flex flex-col justify-between">
                                <div>
                                    <h3 class="text-xl font-bold text-white mb-4 flex items-center gap-2 border-b border-border-dark/50 pb-3">
                                        <i class="fas fa-calculator text-green-400"></i> Resumo Financeiro
                                    </h3>
                                    <div class="space-y-3 text-sm">
                                        <div class="flex justify-between"><span class="text-text-secondary">Total de Pedidos:</span> <span class="font-bold text-white">${data.pedidos?.length || 0}</span></div>
                                        <div class="flex justify-between"><span class="text-text-secondary">Total de Notas Fiscais:</span> <span class="font-bold text-white">${data.pedidos?.reduce((acc, p) => acc + (p.notasFiscais?.length || 0), 0) || 0}</span></div>
                                    </div>
                                </div>
                                <div class="mt-6 pt-4 border-t border-border-dark/50">
                                    <p class="text-text-secondary mb-1">Valor Total Estimado:</p>
                                    <p class="text-3xl font-black text-green-400">R$ ${calcularValorTotal(data)}</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- LINHA √öNICA: PEDIDOS E NFS -->
                    <div class="card-detail p-6 rounded-2xl">
                        <h3 class="text-2xl font-bold text-white mb-6 flex items-center gap-3">
                            <i class="fas fa-file-invoice-dollar text-green-400"></i> Itens Detalhados da Entrega
                        </h3>
                        ${nfsHTML}
                    </div>

                    <!-- LINHA √öNICA: HIST√ìRICO DETALHADO -->
                    <div class="card-detail p-6 rounded-2xl">
                        <h3 class="text-2xl font-bold text-white mb-6 flex items-center gap-3">
                            <i class="fas fa-timeline-ol text-yellow-400"></i> Comunica√ß√£o e Hist√≥rico
                        </h3>
                        ${communicationHistoryHTML}
                    </div>


                    <!-- LINHA √öNICA: OBSERVA√á√ïES -->
                    ${data.observacoes ? `
                        <div class="card-detail p-6 rounded-2xl">
                            <h3 class="text-xl font-bold text-white mb-4 flex items-center gap-2">
                                <i class="fas fa-comment-alt text-gray-500"></i> Observa√ß√µes
                            </h3>
                            <p class="text-text-secondary bg-bg-dark p-4 rounded-lg border border-border-dark">${data.observacoes}</p>
                        </div>
                    ` : ''}
                </div>
            `;
            document.getElementById('agendamento-detalhes').innerHTML = detailsHTML;
        }

        async function fetchAgendamentoAndRender(codigo) {
            document.getElementById('display-codigo').textContent = codigo;
            document.getElementById('display-codigo').classList.add('animate-pulse');
            const agendamentoDiv = document.getElementById('agendamento-detalhes');
            agendamentoDiv.innerHTML = `<div class="card-detail text-center p-10"><p class="text-xl text-orange-400"><i class="fas fa-spinner fa-spin mr-2"></i>Buscando detalhes para ${codigo}...</p></div>`;

            try {
                // Simula√ß√£o de delay para a API
                await new Promise(resolve => setTimeout(resolve, 500)); 

                const response = await fetch(`${API_BASE_URL}/api/agendamentos/consultar/${codigo}`);
                const result = await response.json();
                
                if (result.success && result.data) {
                    renderAgendamentoDetalhes(result.data);
                } else {
                    agendamentoDiv.innerHTML = `<div class="card-detail text-center p-10 bg-red-900/30 border-red-700 text-red-400"><i class="fas fa-times-circle mr-2"></i>Agendamento ${codigo} n√£o encontrado.</div>`;
                    showNotification(`Agendamento ${codigo} n√£o encontrado.`, 'error');
                }
            } catch (error) {
                agendamentoDiv.innerHTML = `<div class="card-detail text-center p-10 bg-red-900/30 border-red-700 text-red-400"><i class="fas fa-exclamation-triangle mr-2"></i>Erro ao consultar o agendamento. Verifique a conex√£o com a API.</div>`;
                showNotification('Erro de conex√£o com a API.', 'error');
            }
        }

        // --- INICIALIZA√á√ÉO ---
        function init() {
            const codigo = new URLSearchParams(window.location.search).get('codigo');
            if (codigo) {
                fetchAgendamentoAndRender(codigo);
            } else {
                // Exibe a mensagem de inicializa√ß√£o se n√£o houver c√≥digo na URL
                document.getElementById('agendamento-detalhes').innerHTML = `
                    <div class="card-detail text-center p-12 rounded-2xl shadow-deep space-y-4">
                        <i class="fas fa-route text-6xl text-orange-primary mb-4 animate-float"></i>
                        <h2 class="text-3xl font-bold text-white">Nenhum C√≥digo Fornecido</h2>
                        <p class="text-lg text-text-secondary">Utilize o bot√£o **Consultar outro** na barra de navega√ß√£o superior para inserir o c√≥digo de agendamento e ver os detalhes.</p>
                    </div>
                `;
            }
            
            // Adicionar listeners
            document.getElementById('consulta-form')?.addEventListener('submit', function(e) {
                e.preventDefault();
                const codigoInput = document.getElementById('codigo-consulta').value.trim();
                if (codigoInput) {
                    closeConsultaModal();
                    // Redireciona a pr√≥pria p√°gina com o novo c√≥digo
                    window.location.href = `consultar-agendamento.html?codigo=${encodeURIComponent(codigoInput)}`;
                }
            });
            document.getElementById('form-cancelar-solicitacao')?.addEventListener('submit', enviarMotivoCancelamento);
            document.getElementById('contra-proposta-form')?.addEventListener('submit', enviarContraProposta);

            // Fechar modais ao clicar no backdrop
            document.addEventListener('click', (e) => {
                if (e.target.classList.contains('modal-backdrop')) {
                    if (!document.getElementById('consulta-modal').classList.contains('hidden')) { closeConsultaModal(); }
                    if (!document.getElementById('cancelar-solicitacao-modal').classList.contains('hidden')) { fecharCancelarSolicitacaoModal(); }
                    if (!document.getElementById('contra-proposta-modal').classList.contains('hidden')) { fecharContraPropostaModal(); }
                }
            });
        }

        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>