<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Consulta de Agendamento | BrisaLOG - Acompanhamento Din√¢mico</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="config.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'bg-dark': '#0D0D0D',
                        'card-dark': '#181818',
                        'border-dark': '#2E2E2E',
                        'orange-primary': '#FF6B35',
                        'orange-secondary': '#FF8C42',
                        'gray-light': '#EFEFEF',
                        'text-secondary': '#B0B0B0',
                        'info-bg': '#1B263B',
                        'info-text': '#85A3C7',
                    },
                    keyframes: {
                        'timeline-pulse': {
                            '0%, 100%': { transform: 'scale(1)', opacity: '0.8' },
                            '50%': { transform: 'scale(1.2)', opacity: '1' },
                        },
                        'float-3d': {
                            '0%, 100%': { transform: 'translateY(0) perspective(500px) rotateX(0deg)' },
                            '50%': { transform: 'translateY(-5px) perspective(500px) rotateX(2deg)' },
                        },
                        'orbit': {
                            '0%': { transform: 'rotateY(0deg) translateZ(20px) rotateY(0deg)' },
                            '100%': { transform: 'rotateY(360deg) translateZ(20px) rotateY(-360deg)' },
                        },
                        'pulse-glow': {
                            '0%, 100%': { boxShadow: '0 0 5px rgba(255, 107, 53, 0.5)' },
                            '50%': { boxShadow: '0 0 20px rgba(255, 107, 53, 0.8), 0 0 30px rgba(255, 107, 53, 0.6)' },
                        },
                        'road-move': {
                            '0%': { backgroundPosition: '0 0' },
                            '100%': { backgroundPosition: '60px 0' },
                        },
                    },
                    animation: {
                        'timeline-pulse': 'timeline-pulse 2s ease-in-out infinite',
                        'float-3d': 'float-3d 5s ease-in-out infinite',
                        'orbit': 'orbit 8s linear infinite',
                        'pulse-glow': 'pulse-glow 2s ease-in-out infinite',
                        'road-move': 'road-move 1s linear infinite',
                    },
                    boxShadow: {
                        'deep': '0 10px 30px rgba(0, 0, 0, 0.6), 0 0 10px rgba(255, 107, 53, 0.1)',
                        'card-hover': '0 8px 30px rgba(255, 107, 53, 0.15)',
                        'glow': '0 0 15px rgba(255, 107, 53, 0.7)',
                    }
                }
            }
        }
    </script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: 'Inter', sans-serif;
            overflow-x: hidden;
            background: #000;
            color: #fff;
        }
        .dark-bg {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle at 50% 50%, #1a0a0a 0%, #000 100%);
            z-index: -2;
        }
        .grid-background {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: 
                linear-gradient(rgba(255, 107, 53, 0.03) 1px, transparent 1px),
                linear-gradient(90deg, rgba(255, 107, 53, 0.03) 1px, transparent 1px);
            background-size: 60px 60px;
            z-index: -1;
            animation: grid-move 20s linear infinite;
        }
        @keyframes grid-move {
            0% { transform: translate(0, 0); }
            100% { transform: translate(60px, 60px); }
        }
        .particles-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 0;
        }
        .particle {
            position: absolute;
            width: 4px;
            height: 4px;
            background: #FF6B35;
            border-radius: 50%;
            filter: blur(1px);
            opacity: 0;
            animation: particle-rise 15s infinite ease-in;
        }
        @keyframes particle-rise {
            0% {
                transform: translateY(100vh) scale(0);
                opacity: 0;
            }
            10% {
                opacity: 1;
            }
            90% {
                opacity: 1;
            }
            100% {
                transform: translateY(-100px) scale(1);
                opacity: 0;
            }
        }
        .navbar {
            background: rgba(20,20,20,0.98);
            backdrop-filter: blur(5px);
            border-bottom: 1px solid #FF6B35;
            position: sticky;
            top: 0;
            z-index: 50;
            box-shadow: 0 4px 15px rgba(0,0,0,0.5);
        }
        
        /* NOVOS ESTILOS PARA A TIMELINE 3D */
        .timeline-3d-container {
            perspective: 1200px;
            transform-style: preserve-3d;
        }
        
        .timeline-road {
            background: linear-gradient(90deg, 
                transparent 0%, 
                rgba(255, 107, 53, 0.3) 20%, 
                rgba(255, 107, 53, 0.6) 50%, 
                rgba(255, 107, 53, 0.3) 80%, 
                transparent 100%);
            height: 8px;
            border-radius: 4px;
            position: relative;
            transform: rotateX(60deg);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.5);
            background-size: 60px 100%;
            animation: road-move 1s linear infinite;
        }
        
        .timeline-step-3d {
            transform-style: preserve-3d;
            transition: all 0.5s ease;
        }
        
        .timeline-step-3d:hover {
            transform: translateY(-5px) scale(1.05);
        }
        
        .step-icon-3d {
            transform-style: preserve-3d;
            transition: all 0.3s ease;
        }
        
        .step-icon-3d:hover {
            transform: rotateY(15deg) scale(1.1);
        }
        
        .timeline-glow {
            position: absolute;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            filter: blur(15px);
            opacity: 0.7;
            z-index: -1;
        }
        
        .truck-3d {
            transform-style: preserve-3d;
            transform: translateZ(20px);
            filter: drop-shadow(0 5px 15px rgba(255, 107, 53, 0.5));
        }
        
        .status-badge-3d {
            transform: translateZ(10px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }
        
        .orbit-ring {
            position: absolute;
            border: 2px dashed rgba(255, 107, 53, 0.3);
            border-radius: 50%;
            transform-style: preserve-3d;
        }
        
        .floating-particle {
            position: absolute;
            width: 6px;
            height: 6px;
            background: #FF6B35;
            border-radius: 50%;
            filter: blur(1px);
            opacity: 0.7;
            transform-style: preserve-3d;
        }
        
        .card-detail {
            background: #181818;
            border: 2px solid #FF6B35;
            border-radius: 1rem;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.7), 0 0 20px rgba(255, 107, 53, 0.15);
            transition: box-shadow 0.3s, border-color 0.3s;
        }
        .card-detail:hover {
            box-shadow: 0 16px 40px rgba(255, 107, 53, 0.25), 0 0 30px rgba(255, 107, 53, 0.25);
            border-color: #FF8C42;
        }
    </style>
</head>
<body>
    <div class="dark-bg"></div>
    <div class="grid-background"></div>
    <div class="particles-container" id="particles"></div>
    
    <nav class="navbar">
        <div class="max-w-7xl mx-auto px-6 py-4 flex items-center justify-between">
            <div class="flex items-center gap-3">
                <a href="index.html" class="w-10 h-10 bg-gradient-to-br from-orange-500 to-orange-600 rounded-lg flex items-center justify-center">
                    <i class="fas fa-truck-fast text-white text-xl"></i>
                </a>
                <span class="font-bold text-xl text-white">BrisaLOG Agenda</span>
            </div>
            <div class="flex gap-4 items-center">
                <a href="index.html" class="text-text-secondary hover:text-white transition-colors"><i class="fas fa-arrow-left mr-2"></i>Voltar ao In√≠cio</a>
                <button onclick="openConsultaModal()" class="bg-orange-primary hover:bg-orange-secondary text-white font-semibold py-2 px-4 rounded-lg transition-colors"><i class="fas fa-search mr-2"></i>Consultar outro</button>
            </div>
        </div>
    </nav>
    
    <main class="max-w-7xl mx-auto px-4 py-12">
        <header class="text-center mb-8">
            <h1 class="text-4xl font-black text-white mb-2 tracking-tight">
                DASHBOARD DO AGENDAMENTO <span id="display-codigo" class="text-orange-primary font-mono">...</span>
            </h1>
            <p class="text-lg text-text-secondary">Todos os dados do seu agendamento em uma √∫nica tela.</p>
        </header>

        <div id="agendamento-detalhes">
            <div class="grid grid-cols-2 gap-8 items-stretch">
                <div class="card-detail p-10 rounded-2xl flex flex-col items-center justify-center">
                    <i class="fas fa-route text-6xl text-orange-primary mb-4 animate-float"></i>
                    <p class="text-xl text-text-secondary"><i class="fas fa-spinner fa-spin mr-2"></i>Carregando detalhes...</p>
                </div>
            </div>
        </div>
    </main>

    <footer class="text-center py-6 text-text-secondary border-t border-border-dark mt-12">
        <p class="text-sm">&copy; 2025 BrisaLOG Agenda. Desenvolvido por Wanderson Davyd. Todos os direitos reservados.</p>
    </footer>

    <!-- MODAIS -->
    <div id="consulta-modal" class="hidden fixed inset-0 modal-backdrop z-[100] flex items-center justify-center">
        <div class="bg-card-dark rounded-2xl max-w-md w-full mx-4 border border-border-dark shadow-deep">
            <div class="p-6">
                <div class="text-center mb-6">
                    <div class="bg-gradient-to-r from-orange-primary to-orange-secondary p-4 rounded-2xl inline-block mb-4">
                        <i class="fas fa-search text-white text-2xl"></i>
                    </div>
                    <h2 class="text-2xl font-bold text-white mb-2">Consultar Agendamento</h2>
                    <p class="text-text-secondary">Digite o c√≥digo do seu agendamento</p>
                </div>
                <form id="consulta-form" class="space-y-4">
                    <div>
                        <label class="block text-white font-semibold mb-2">C√≥digo do Agendamento</label>
                        <input type="text" id="codigo-consulta" required class="w-full px-4 py-3 border border-border-dark rounded-lg bg-bg-dark text-white focus:border-orange-primary focus:ring-2 focus:ring-orange-primary focus:ring-opacity-20 transition-all" placeholder="AGD123456">
                    </div>
                    <div class="flex justify-end space-x-4 mt-6">
                        <button type="button" onclick="closeConsultaModal()" class="bg-gray-700 text-white px-6 py-2 rounded-lg hover:bg-gray-600 transition-all">Cancelar</button>
                        <button type="submit" class="bg-orange-primary hover:bg-orange-secondary text-white font-semibold py-2 px-4 rounded-lg transition-colors"><i class="fas fa-search mr-2"></i>Consultar</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div id="contra-proposta-modal" class="fixed inset-0 bg-black bg-opacity-70 hidden z-[110] modal-backdrop">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-card-dark rounded-xl max-w-md w-full border border-border-dark shadow-deep">
                <div class="p-6 border-b border-border-dark">
                    <div class="flex justify-between items-center">
                        <h2 class="text-xl font-bold text-white">
                            <i class="fas fa-calendar-alt mr-2 text-blue-400"></i>
                            <span id="modal-reagendar-titulo">Sugerir Nova Data</span>
                        </h2>
                        <button type="button" onclick="fecharContraPropostaModal()" class="text-text-secondary hover:text-white text-xl">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <p class="text-text-secondary mt-2" id="modal-reagendar-descricao">Selecione a nova data para o seu agendamento.</p>
                </div>
                
                <div class="p-6">
                    <form id="contra-proposta-form">
                        <div class="space-y-4">
                            <div>
                                <label for="contra-proposta-data" class="block text-sm font-medium text-white mb-1">Nova Data *</label>
                                <input type="date" id="contra-proposta-data" name="novaData" required 
                                    class="w-full px-3 py-2 bg-gray-800 text-white border border-gray-600 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            </div>
                            
                            <div>
                                <label for="contra-proposta-horario" class="block text-sm font-medium text-white mb-1">Novo Hor√°rio *</label>
                                <select id="contra-proposta-horario" name="novoHorario" required 
                                    class="w-full px-3 py-2 bg-gray-800 text-white border border-gray-600 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                    <option value="">Selecione o hor√°rio</option>
                                </select>
                            </div>
                            
                            <div>
                                <label for="contra-proposta-comentario" class="block text-sm font-medium text-white mb-1">Coment√°rio (opcional)</label>
                                <textarea id="contra-proposta-comentario" name="comentario" rows="3" placeholder="Explique o motivo da nova data sugerida..."
                                    class="w-full px-3 py-2 bg-gray-800 text-white border border-gray-600 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500 placeholder-gray-400"></textarea>
                            </div>
                        </div>
                        
                        <div class="flex gap-3 mt-6">
                            <button type="submit" class="flex-1 bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700 transition-all font-medium">
                                <i class="fas fa-paper-plane mr-2"></i>Enviar Proposta
                            </button>
                            <button type="button" onclick="fecharContraPropostaModal()" class="px-4 py-2 border border-gray-600 text-text-secondary rounded-md hover:bg-gray-700 transition-all">
                                Cancelar
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <div id="cancelar-solicitacao-modal" class="hidden fixed inset-0 modal-backdrop z-[110] flex items-center justify-center">
        <div class="bg-card-dark rounded-xl shadow-deep p-8 w-full max-w-md border border-red-600">
            <h2 class="text-xl font-bold mb-4 text-red-500"><i class="fas fa-exclamation-triangle mr-2"></i>Confirma√ß√£o de Cancelamento</h2>
            <p class="text-text-secondary mb-4">Se voc√™ cancelar esta solicita√ß√£o, todos os dados ser√£o permanentemente removidos. Por favor, confirme o motivo.</p>
            <form id="form-cancelar-solicitacao">
                <label for="motivo-cancelamento" class="block text-sm font-medium text-white mb-2">Motivo do cancelamento:</label>
                <textarea id="motivo-cancelamento" name="motivo" rows="3" required class="w-full border border-border-dark rounded-lg p-2 mb-4 bg-bg-dark"></textarea>
                <div class="flex justify-end gap-2">
                    <button type="button" onclick="fecharCancelarSolicitacaoModal()" class="bg-gray-700 text-white px-4 py-2 rounded-lg hover:bg-gray-600">Voltar</button>
                    <button type="submit" class="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700">Confirmar Cancelamento</button>
                </div>
            </form>
        </div>
    </div>

    <div id="notification-container" class="fixed top-5 right-5 space-y-2 z-[150]"></div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const particlesContainer = document.getElementById('particles');
            if (particlesContainer) {
                for (let i = 0; i < 30; i++) {
                    const particle = document.createElement('div');
                    particle.className = 'particle';
                    particle.style.left = Math.random() * 100 + '%';
                    particle.style.animationDelay = Math.random() * 15 + 's';
                    particle.style.animationDuration = (10 + Math.random() * 10) + 's';
                    particlesContainer.appendChild(particle);
                }
            }
        });
        
        let currentAgendamento = null;
        let currentCodigoReagendamento = null;

        const statusMap = {
            'pendente': { text: 'Aguardando Confirma√ß√£o', icon: 'fa-clock', color: 'status-pendente', step: 1, progress: 20, description: 'Sua solicita√ß√£o foi recebida e est√° na fila de aprova√ß√£o do CD.' },
            'confirmado': { text: 'Agendamento Confirmado', icon: 'fa-calendar-check', color: 'status-confirmado', step: 2, progress: 45, description: 'A data e hor√°rio foram confirmados. Aguardamos sua chegada.' },
            'em_transito': { text: 'Em Tr√¢nsito/Check-in', icon: 'fa-truck-fast', color: 'status-confirmado', step: 3, progress: 70, description: 'O transporte est√° a caminho ou j√° est√° na √°rea de check-in.' },
            'entregue': { text: 'Entrega Conclu√≠da', icon: 'fa-box-open', color: 'status-confirmado', step: 4, progress: 100, description: 'A entrega foi realizada com sucesso.' },
            'reagendamento': { text: 'Reagendar (Aguardando Resposta)', icon: 'fa-sync-alt', color: 'status-reagendamento', step: 2.5, progress: 35, description: 'O CD sugeriu uma nova data/hor√°rio. Sua resposta √© necess√°ria.' },
            'nao-veio': { text: 'N√£o Compareceu (Reagendar)', icon: 'fa-user-slash', color: 'status-nao-veio', step: 2.5, progress: 35, description: 'O transportador n√£o compareceu na data agendada. Por favor, reagende.' },
            'cancelado': { text: 'Cancelado', icon: 'fa-ban', color: 'status-cancelado', step: 0, progress: 0, description: 'O agendamento foi cancelado.' },
            'aguardando_resposta_cd': { text: 'Proposta Enviada (Aguarde CD)', icon: 'fa-reply-all', color: 'status-pendente', step: 1.5, progress: 30, description: 'Sua contraproposta foi enviada. O CD est√° analisando.' }
        };

        function formatDateBrFromISO(isoString) {
            if (!isoString) return 'N/A';
            try {
                const dateStr = isoString.slice(0, 10);
                const [year, month, day] = dateStr.split('-');
                return `${day}/${month}/${year}`;
            } catch (e) {
                return 'Data Inv√°lida';
            }
        }
        
        function showNotification(message, type = 'info') {
            const colors = { success: 'bg-green-600', error: 'bg-red-600', warning: 'bg-yellow-500', info: 'bg-blue-600' };
            const icons = { success: 'fa-check-circle', error: 'fa-exclamation-circle', warning: 'fa-exclamation-triangle', info: 'fa-info-circle' };
            
            const notification = document.createElement('div');
            notification.className = `px-6 py-4 rounded-lg shadow-xl flex items-center space-x-3 transition-opacity duration-300 ${colors[type]} text-white`;
            notification.innerHTML = `<i class="fas ${icons[type]}"></i><span>${message}</span><button onclick="this.parentElement.remove()" class="ml-4 hover:bg-white hover:bg-opacity-20 rounded p-1"><i class="fas fa-times"></i></button>`;
            
            document.getElementById('notification-container').prepend(notification);
            setTimeout(() => { notification.style.opacity = 0; setTimeout(() => notification.remove(), 300); }, 5000);
        }
        
        function calcularValorTotal(agendamento) {
            const allNFs = [];
            if (agendamento.pedidos && agendamento.pedidos.length > 0) {
                agendamento.pedidos.forEach(p => p.notasFiscais?.forEach(nf => allNFs.push(nf)));
            } else if (agendamento.notasFiscais) {
                agendamento.notasFiscais.forEach(nf => allNFs.push(nf));
            }
            if (allNFs.length === 0) return '0,00';
            let total = 0;
            allNFs.forEach(nf => {
                // Valor vem como n√∫mero do backend
                const v = typeof nf.valor === 'number' ? nf.valor : parseFloat(nf.valor) || 0;
                total += v;
            });
            return total.toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2});
        }
        
        function viewPDF(arquivo) {
            if (!arquivo) {
                showNotification('Arquivo PDF n√£o dispon√≠vel.', 'error');
                return;
            }
            window.open(`${API_BASE_URL}/api/files/${arquivo}`, '_blank');
        }

        function openConsultaModal() { document.getElementById('consulta-modal').classList.remove('hidden'); }
        function closeConsultaModal() { document.getElementById('consulta-modal').classList.add('hidden'); }
        function abrirCancelarSolicitacaoModal(codigo) { 
            currentCodigoReagendamento = codigo; 
            document.getElementById('form-cancelar-solicitacao').onsubmit = (e) => {
                e.preventDefault();
                enviarMotivoCancelamento(e);
            };
            document.getElementById('cancelar-solicitacao-modal').classList.remove('hidden'); 
        }
        function fecharCancelarSolicitacaoModal() { document.getElementById('cancelar-solicitacao-modal').classList.add('hidden'); document.getElementById('motivo-cancelamento').value = ''; }
        
        // Fun√ß√µes de valida√ß√£o de data para reagendamento
        function isValidScheduleDateReagendar(dateString) {
            const date = new Date(dateString + 'T00:00:00');
            const day = date.getDay();
            const dayOfMonth = date.getDate();
            if (day === 0 || day === 6) return false;
            if (dayOfMonth > 25) return false;
            return true;
        }
        
        function getNextValidDateReagendar(date) {
            const next = new Date(date);
            next.setDate(next.getDate() + 1);
            while (!isValidScheduleDateReagendar(formatDateToISOReagendar(next))) {
                next.setDate(next.getDate() + 1);
                if (next.getDate() > 25) {
                    next.setMonth(next.getMonth() + 1);
                    next.setDate(1);
                }
            }
            return next;
        }
        
        function formatDateToISOReagendar(date) {
            const yyyy = date.getFullYear();
            const mm = String(date.getMonth() + 1).padStart(2, '0');
            const dd = String(date.getDate()).padStart(2, '0');
            return `${yyyy}-${mm}-${dd}`;
        }
        
        async function carregarHorariosDisponiveis(data, cdDestino) {
            const horarioSelect = document.getElementById('contra-proposta-horario');
            horarioSelect.innerHTML = '<option value="">Carregando hor√°rios...</option>';
            
            try {
                const response = await fetch(`${API_BASE_URL}/api/horarios-disponiveis?date=${data}&cd=${cdDestino}`);
                const result = await response.json();
                
                if (result.horarios && Array.isArray(result.horarios)) {
                    horarioSelect.innerHTML = '<option value="">Selecione o hor√°rio</option>';
                    result.horarios.forEach(horario => {
                        const option = document.createElement('option');
                        option.value = horario.valor;
                        option.textContent = horario.label;
                        if (horario.disponivel === false) {
                            option.disabled = true;
                            option.textContent += ` (${horario.motivo || 'Indispon√≠vel'})`;
                        }
                        horarioSelect.appendChild(option);
                    });
                } else {
                    horarioSelect.innerHTML = '<option value="">Selecione o hor√°rio</option><option value="08:00">08:00 - 09:00</option><option value="09:00">09:00 - 10:00</option><option value="10:00">10:00 - 11:00</option><option value="11:00">11:00 - 12:00</option><option value="14:00">14:00 - 15:00</option><option value="15:00">15:00 - 16:00</option><option value="16:00">16:00 - 17:00</option><option value="17:00">17:00 - 18:00</option>';
                }
            } catch (error) {
                console.error('Erro ao carregar hor√°rios:', error);
                horarioSelect.innerHTML = '<option value="">Selecione o hor√°rio</option><option value="08:00">08:00 - 09:00</option><option value="09:00">09:00 - 10:00</option><option value="10:00">10:00 - 11:00</option><option value="11:00">11:00 - 12:00</option><option value="14:00">14:00 - 15:00</option><option value="15:00">15:00 - 16:00</option><option value="16:00">16:00 - 17:00</option><option value="17:00">17:00 - 18:00</option>';
            }
        }
        
        function abrirContraProposta(codigo) {
            currentCodigoReagendamento = codigo;
            const isNaoVeio = currentAgendamento?.status === 'nao-veio';
            document.getElementById('modal-reagendar-titulo').textContent = isNaoVeio ? 'Reagendar Entrega' : 'Sugerir Nova Data';
            document.getElementById('modal-reagendar-descricao').textContent = isNaoVeio ? 'Escolha uma nova data e hor√°rio para realizar a entrega.' : 'Sugira uma nova data e hor√°rio para a equipe do CD.';
            document.getElementById('contra-proposta-form').onsubmit = (e) => {
                e.preventDefault();
                enviarContraProposta(e);
            };
            
            // Configurar data m√≠nima e valor padr√£o
            const dataInput = document.getElementById('contra-proposta-data');
            const today = new Date();
            const nextValid = getNextValidDateReagendar(today);
            const minDate = formatDateToISOReagendar(nextValid);
            dataInput.setAttribute('min', minDate);
            dataInput.value = minDate;
            dataInput.setAttribute('title', 'Selecione apenas dias √∫teis (seg-sex) at√© o dia 25 de cada m√™s');
            
            // Event listener para validar data
            dataInput.onchange = function() {
                if (!isValidScheduleDateReagendar(this.value)) {
                    const selectedDate = new Date(this.value + 'T00:00:00');
                    const dayOfMonth = selectedDate.getDate();
                    let message = '';
                    if (dayOfMonth > 25) {
                        message = 'N√£o √© poss√≠vel agendar entregas ap√≥s o dia 25 do m√™s. Selecionando pr√≥xima data dispon√≠vel...';
                    } else {
                        message = 'Por favor, selecione apenas dias √∫teis (segunda a sexta-feira). Selecionando pr√≥xima data dispon√≠vel...';
                    }
                    alert(message);
                    const nextValid = getNextValidDateReagendar(selectedDate);
                    this.value = formatDateToISOReagendar(nextValid);
                }
                // Carregar hor√°rios dispon√≠veis ao mudar a data
                const cdDestino = currentAgendamento?.cdDestino || 'CD1';
                carregarHorariosDisponiveis(this.value, cdDestino);
            };
            
            // Bloquear digita√ß√£o manual
            dataInput.onkeydown = function(e) {
                if (!['Tab', 'Escape', 'Enter'].includes(e.key)) {
                    e.preventDefault();
                }
            };
            
            // Carregar hor√°rios para a data padr√£o
            const cdDestino = currentAgendamento?.cdDestino || 'CD1';
            carregarHorariosDisponiveis(minDate, cdDestino);
            
            document.getElementById('contra-proposta-modal').classList.remove('hidden');
        }
        function fecharContraPropostaModal() { document.getElementById('contra-proposta-modal').classList.add('hidden'); currentCodigoReagendamento = null; }
        
        async function responderReagendamento(codigo, resposta) {
            if (!confirm(`Tem certeza que deseja ${resposta === 'aceito' ? 'ACEITAR' : 'REJEITAR'} esta sugest√£o de reagendamento?`)) return;
            try {
                const response = await fetch(`${API_BASE_URL}/api/agendamentos/${codigo}/responder-reagendamento`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ resposta: resposta, comentario: '' }) });
                const result = await response.json();
                if (result.success) {
                    showNotification(`Reagendamento ${resposta === 'aceito' ? 'ACEITO' : 'REJEITADO'} com sucesso!`, 'success');
                    await fetchAgendamentoAndRender(codigo); 
                } else { showNotification(result.error || 'Erro ao responder reagendamento.', 'error'); }
            } catch (error) { showNotification('Erro de conex√£o ao responder reagendamento.', 'error'); }
        }
        async function enviarMotivoCancelamento(event) {
            event.preventDefault();
            const codigo = currentCodigoReagendamento;
            const motivo = document.getElementById('motivo-cancelamento').value.trim();
            if (!motivo) { showNotification('Informe o motivo do cancelamento.', 'error'); return; }
            try {
                const response = await fetch(`${API_BASE_URL}/api/agendamentos/${codigo}/cancelar`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ motivo: motivo }) });
                const result = await response.json();
                if (result.success) {
                    fecharCancelarSolicitacaoModal();
                    showNotification('Solicita√ß√£o de cancelamento enviada!', 'success');
                    await fetchAgendamentoAndRender(codigo);
                } else { showNotification(result.message || 'Erro ao cancelar solicita√ß√£o.', 'error'); }
            } catch (error) { showNotification('Erro de conex√£o ao cancelar solicita√ß√£o.', 'error'); }
        }
        async function enviarContraProposta(event) {
            event.preventDefault();
            const codigo = currentCodigoReagendamento;
            const { value: novaData } = document.getElementById('contra-proposta-data');
            const { value: novoHorario } = document.getElementById('contra-proposta-horario');
            const { value: comentario } = document.getElementById('contra-proposta-comentario');
            if (!novaData || !novoHorario) { showNotification('Preencha a data e hor√°rio.', 'error'); return; }

            const isNaoVeio = currentAgendamento?.status === 'nao-veio';
            let apiUrl = isNaoVeio ? `${API_BASE_URL}/api/agendamentos/${codigo}/reagendar-Transportador` : `${API_BASE_URL}/api/agendamentos/${codigo}/responder-reagendamento`;
            let requestBody = isNaoVeio ? { novaData, novoHorario, motivo: comentario } : { resposta: 'contra_proposta', comentario, novaData, novoHorario };
            
            try {
                const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(requestBody) });
                const result = await response.json();
                if (result.success) {
                    showNotification('Proposta de data enviada com sucesso!', 'success');
                    fecharContraPropostaModal();
                    await fetchAgendamentoAndRender(codigo);
                } else { showNotification(result.error || result.message || 'Erro ao enviar proposta.', 'error'); }
            } catch (error) { showNotification('Erro de conex√£o ao enviar proposta.', 'error'); }
        }

        function renderTimeline3D(currentStatus, historico = []) {
            const statusInfo = statusMap[currentStatus];
            // Garante que orbitRingsHTML est√° definido
            let orbitRingsHTML = '';
            // üí° ADICIONE ESTA LINHA PARA CORRIGIR O ERRO:
            let floatingParticlesHTML = '';
            // Se quiser adicionar anima√ß√£o, pode definir aqui
            // orbitRingsHTML = `<div class='orbit-rings'></div>`;

            // Novo fluxo log√≠stico completo
            const timelineStatuses = [
                { key: 'pendente', label: 'Aguardando Confirma√ß√£o', icon: 'fa-clock' },
                { key: 'confirmado', label: 'Agendamento Aprovado', icon: 'fa-calendar-check' },
                { key: 'reagendamento', label: 'Nova Data Sugerida', icon: 'fa-sync-alt' },
                { key: 'aguardando_resposta_cd', label: 'Proposta Enviada (Aguarde CD)', icon: 'fa-reply-all' },
                { key: 'em_transito', label: 'Em Tr√¢nsito', icon: 'fa-truck-fast' },
                { key: 'entregue', label: 'Entrega Realizada', icon: 'fa-box-open' },
                { key: 'nao-veio', label: 'Fornecedor N√£o Compareceu', icon: 'fa-user-slash' },
                { key: 'cancelado', label: 'Cancelado', icon: 'fa-ban' }
            ];

            // Mapeamento do √≠ndice para o caminh√£o
            let statusMapIdx = {
                'pendente': 0,
                'confirmado': 1,
                'reagendamento': 2,
                'aguardando_resposta_cd': 3,
                'em_transito': 4,
                'entregue': 5,
                'nao-veio': 6,
                'cancelado': 7
            };

            // Determina o caminho real percorrido pelo hist√≥rico
            let lastStatusIdx = 0;
            if (Array.isArray(historico) && historico.length > 0) {
                historico.forEach(evento => {
                    // Mapeia a√ß√µes do hist√≥rico para status da timeline
                    if (evento.acao === 'agendamento_criado') lastStatusIdx = Math.max(lastStatusIdx, statusMapIdx['pendente']);
                    if (evento.acao === 'confirmado') lastStatusIdx = Math.max(lastStatusIdx, statusMapIdx['confirmado']);
                    if (evento.acao === 'cd_sugeriu_reagendamento' || evento.acao === 'Transportador_sugeriu_reagendamento') lastStatusIdx = Math.max(lastStatusIdx, statusMapIdx['reagendamento']);
                    if (evento.acao === 'Transportador_aceitou_reagendamento') lastStatusIdx = Math.max(lastStatusIdx, statusMapIdx['aguardando_resposta_cd']);
                    if (evento.acao === 'em_transito') lastStatusIdx = Math.max(lastStatusIdx, statusMapIdx['em_transito']);
                    if (evento.acao === 'entrega_realizada') lastStatusIdx = Math.max(lastStatusIdx, statusMapIdx['entregue']);
                    if (evento.acao === 'ausencia_registrada') lastStatusIdx = Math.max(lastStatusIdx, statusMapIdx['nao-veio']);
                    if (evento.acao === 'cancelado_Transportador') lastStatusIdx = Math.max(lastStatusIdx, statusMapIdx['cancelado']);
                });
            } else {
                lastStatusIdx = statusMapIdx[currentStatus] ?? 0;
            }
            let currentIdx = lastStatusIdx;

            let stepsHTML = '';
            timelineStatuses.forEach((step, idx) => {
                const isCompleted = idx < currentIdx;
                const isActive = idx === currentIdx;
                const positionPercent = (idx / (timelineStatuses.length - 1)) * 100;

                let stepColor = 'bg-gray-700';
                let glowColor = 'rgba(100, 100, 100, 0.3)';
                let stepShadow = '';

                // Cancelado e N√£o Veio mudam a cor
                if (step.key === 'cancelado' && isActive) {
                    stepColor = 'bg-red-600';
                    glowColor = 'rgba(255, 0, 0, 0.5)';
                    stepShadow = 'shadow-glow animate-pulse-glow';
                } else if (step.key === 'nao-veio' && isActive) {
                    stepColor = 'bg-yellow-600';
                    glowColor = 'rgba(255, 200, 0, 0.5)';
                    stepShadow = 'shadow-glow animate-pulse-glow';
                } else if (isCompleted) {
                    stepColor = 'bg-green-500';
                    glowColor = 'rgba(72, 187, 120, 0.5)';
                    stepShadow = 'shadow-glow';
                } else if (isActive) {
                    stepColor = 'bg-orange-primary';
                    glowColor = 'rgba(255, 107, 53, 0.7)';
                    stepShadow = 'shadow-glow animate-pulse-glow';
                }

                stepsHTML += `
                    <div class="timeline-step-3d absolute top-1/2 -translate-y-1/2" style="left: ${positionPercent}%; transform: translateX(-50%) translateZ(20px);">
                        <div class="relative">
                            <div class="timeline-glow ${stepShadow}" style="background: ${glowColor};"></div>
                            <div class="step-icon-3d w-12 h-12 rounded-full flex items-center justify-center text-white shadow-lg ${stepColor} transition-all duration-500 ${isActive ? 'animate-timeline-pulse scale-110' : ''}">
                                <i class="fas ${step.icon} text-xl"></i>
                            </div>
                            <div class="absolute left-1/2 -translate-x-1/2 top-14 w-32 text-center">
                                <p class="text-xs font-bold ${isActive ? (step.key === 'cancelado' ? 'text-red-500' : (step.key === 'nao-veio' ? 'text-yellow-400' : 'text-orange-primary')) : (isCompleted ? 'text-green-400' : 'text-text-secondary')}">
                                    ${step.label}
                                </p>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            const truckPercent = (currentIdx / (timelineStatuses.length - 1)) * 100;
            let showTruck = !(currentStatus === 'cancelado' || currentStatus === 'nao-veio');

            const timelineHTML = `
                <div class="timeline-3d-container rounded-2xl p-8 mb-10 max-w-7xl mx-auto shadow-deep relative overflow-hidden bg-gradient-to-b from-gray-900 to-card-dark border border-border-dark">
                    <h3 class="text-2xl font-extrabold text-white mb-8 flex items-center gap-3">
                        <i class="fas ${statusInfo.icon} text-orange-primary"></i>
                        Fluxo Log√≠stico: <span class="status-badge-3d font-bold ${statusInfo.color} px-3 py-1 rounded-lg bg-card-dark border border-orange-primary/30">${statusInfo.text}</span>
                    </h3>
                    <p class="text-text-secondary mb-8 text-center">${statusInfo.description}</p>

                    <div class="relative h-64 w-full mb-10 flex items-center justify-center">
                        ${orbitRingsHTML}
                        ${floatingParticlesHTML}

                        <div class="timeline-road w-11/12 mx-auto"></div>

                        ${stepsHTML}

                        ${showTruck ? `<div id="timeline-truck" class="truck-3d absolute top-1/2 -translate-y-1/2" style="left: ${truckPercent}%; transition: left 1.5s cubic-bezier(0.4, 0, 0.2, 1);">
                            <div class="relative">
                                <i class="fas fa-truck-fast text-4xl text-orange-primary" style="
                                    filter: drop-shadow(2px 2px 4px rgba(0,0,0,0.5));
                                    animation: float-3d 3s ease-in-out infinite;
                                "></i>
                                <div class="absolute -bottom-2 left-1/2 -translate-x-1/2 w-8 h-1 bg-orange-primary rounded-full blur-sm opacity-70"></div>
                            </div>
                        </div>` : ''}
                    </div>

                    <div class="w-full bg-gray-800 rounded-full h-2.5 mt-6">
                        <div class="bg-gradient-to-r from-orange-primary to-orange-secondary h-2.5 rounded-full transition-all duration-1000" style="width: ${statusInfo.progress}%"></div>
                    </div>
                    <div class="flex justify-between text-xs text-text-secondary mt-2">
                        <span>In√≠cio</span>
                        <span>${statusInfo.progress}% Conclu√≠do</span>
                        <span>Conclus√£o</span>
                    </div>
                </div>
            `;

            return timelineHTML;
        }

        function renderActionButtons(data) {
            let buttons = '';
            
            if (data.status === 'reagendamento') {
                const dataSugestao = data.dataSugestaoCD ? formatDateBrFromISO(data.dataSugestaoCD) : 'N/A';
                const horarioSugestao = data.horarioSugestaoCD || 'n√£o informado';
                
                buttons += `
                    <p class="text-lg font-semibold text-yellow-400">Nova data sugerida pelo CD: ${dataSugestao} √†s ${horarioSugestao}</p>
                    <button onclick="responderReagendamento('${data.codigo}', 'aceito')" class="bg-green-600 hover:bg-green-700 text-white font-semibold py-3 px-6 rounded-lg transition-colors flex items-center"><i class="fas fa-check mr-2"></i>Aceitar Nova Data</button>
                    <button onclick="abrirContraProposta('${data.codigo}')" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-6 rounded-lg transition-colors flex items-center"><i class="fas fa-calendar-plus mr-2"></i>Sugerir Outra Data</button>
                    <button onclick="abrirCancelarSolicitacaoModal('${data.codigo}')" class="bg-red-600 hover:bg-red-700 text-white font-semibold py-3 px-6 rounded-lg transition-colors flex items-center"><i class="fas fa-times-circle mr-2"></i>Cancelar Solicita√ß√£o</button>
                `;
            } 
            else if (data.status === 'nao-veio') {
                buttons += `
                    <p class="text-lg font-semibold text-red-400 mb-4">üö® √â necess√°rio reagendar a entrega!</p>
                    <div class="flex flex-col gap-3 w-full">
                        <button onclick="abrirContraProposta('${data.codigo}')" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-6 rounded-lg transition-colors flex items-center justify-center"><i class="fas fa-redo mr-2"></i>Reagendar Entrega</button>
                        <button onclick="abrirCancelarSolicitacaoModal('${data.codigo}')" class="bg-red-600 hover:bg-red-700 text-white font-semibold py-3 px-6 rounded-lg transition-colors flex items-center justify-center"><i class="fas fa-times-circle mr-2"></i>Cancelar Agendamento</button>
                    </div>
                `;
            }
            else if (data.status === 'pendente' || data.status === 'confirmado' || data.status === 'aguardando_resposta_cd' || data.status === 'em_transito') {
                 buttons += `
                    <p class="text-lg font-semibold text-text-secondary"><i class="fas fa-lock mr-2 text-green-400"></i>Agendamento Ativo. Para alterar, solicite o cancelamento.</p>
                    <button onclick="abrirCancelarSolicitacaoModal('${data.codigo}')" class="bg-red-600 hover:bg-red-700 text-white font-semibold py-3 px-6 rounded-lg transition-colors flex items-center"><i class="fas fa-times-circle mr-2"></i>Cancelar Solicita√ß√£o</button>
                `;
            }
            else if (data.status === 'entregue' || data.status === 'cancelado') {
                buttons += `<p class="text-lg font-semibold text-green-400"><i class="fas fa-bookmark mr-2"></i>Este agendamento est√° finalizado. Nenhuma a√ß√£o necess√°ria.</p>`;
            }

            return buttons;
        }

        function getHistoryStyle(acao) {
            const styles = {
                'agendamento_criado': { icon: 'fa-plus-circle', color: 'border-blue-500', title: 'Agendamento Criado' },
                'cd_sugeriu_reagendamento': { icon: 'fa-calendar-alt', color: 'border-yellow-500', title: 'Nova Data Sugerida (CD)' },
                'Transportador_sugeriu_reagendamento': { icon: 'fa-reply-all', color: 'border-blue-400', title: 'Contra Proposta Enviada' },
                'Transportador_aceitou_reagendamento': { icon: 'fa-check-double', color: 'border-green-500', title: 'Nova Data Aceita' },
                'Transportador_rejeitou_reagendamento': { icon: 'fa-thumbs-down', color: 'border-red-500', title: 'Proposta Rejeitada' },
                'entrega_realizada': { icon: 'fa-box-open', color: 'border-green-600', title: 'Entrega Conclu√≠da' },
                'ausencia_registrada': { icon: 'fa-user-slash', color: 'border-red-500', title: 'Aus√™ncia Registrada' },
                'cancelado_Transportador': { icon: 'fa-ban', color: 'border-red-500', title: 'Solicita√ß√£o Cancelada' },
                'confirmado': { icon: 'fa-check-circle', color: 'border-green-500', title: 'Agendamento Confirmado' }
            };
            return styles[acao] || { icon: 'fa-info-circle', color: 'border-gray-500', title: 'Evento do Sistema' };
        }

        function renderCommunicationHistory(data) {
            const historico = data.historico || [];
            if (historico.length === 0) {
                return '<div class="text-center py-4 text-text-secondary">Nenhum evento registrado.</div>';
            }

            return `
                <div class="space-y-4">
                    ${historico.reverse().map(evento => { 
                        const style = getHistoryStyle(evento.acao);
                        const dataFormatada = evento.data ? new Date(evento.data).toLocaleString('pt-BR', { dateStyle: 'short', timeStyle: 'short' }) : 'Agora';
                        
                        return `
                            <div class="event-detail-card p-4 rounded-lg shadow-sm border-l-4 ${style.color}">
                                <div class="flex items-center justify-between mb-2">
                                    <p class="font-semibold text-white flex items-center gap-2">
                                        <i class="fas ${style.icon} text-orange-primary text-sm"></i> ${style.title}
                                    </p>
                                    <span class="text-xs text-text-secondary">${dataFormatada}</span>
                                </div>
                                <p class="text-sm text-text-secondary leading-relaxed">
                                    ${evento.descricao || 'Detalhes n√£o informados.'}
                                </p>
                                ${(evento.novaData || evento.novoHorario) ? `
                                    <div class="mt-2 text-xs text-blue-400 font-medium">
                                        <i class="fas fa-calendar-day mr-1"></i> ${formatDateBrFromISO(evento.novaData) || 'N/A'} - ${evento.novoHorario || 'N/A'}
                                    </div>
                                ` : ''}
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
        }

        function renderPedidosENotasFiscais(data) {
            const allPedidos = {}; 
            
            if (data.pedidos && data.pedidos.length > 0) {
                data.pedidos.forEach(p => {
                    allPedidos[p.numero] = {
                        numero: p.numero,
                        notasFiscais: p.notasFiscais || []
                    };
                });
            } else if (data.notasFiscais) {
                 data.notasFiscais.forEach(nf => {
                    const pedidoNum = nf.numeroPedido || 'N/A';
                    if (!allPedidos[pedidoNum]) {
                        allPedidos[pedidoNum] = { numero: pedidoNum, notasFiscais: [] };
                    }
                    allPedidos[pedidoNum].notasFiscais.push(nf);
                 });
            }

            const pedidosArray = Object.values(allPedidos).filter(p => p.notasFiscais.length > 0);

            if (pedidosArray.length === 0) {
                return '<div class="text-center py-4 text-text-secondary">Nenhum Pedido ou Nota Fiscal vinculada.</div>';
            }

            let html = ``;

            pedidosArray.forEach(pedido => {
                html += `
                    <div class="bg-gray-800 p-4 rounded-xl border border-border-dark mb-4">
                        <h4 class="font-bold text-lg text-white mb-3 flex items-center gap-2 border-b border-border-dark/50 pb-2">
                            <i class="fas fa-tag text-orange-400"></i> Pedido: ${pedido.numero || 'N/A'}
                            <span class="text-xs ml-auto text-text-secondary">NFs no Pedido: ${pedido.notasFiscais.length}</span>
                        </h4>
                        <div class="space-y-3 pt-2">
                            ${pedido.notasFiscais.map(nf => {
                                const nfValor = calcularValorNF(nf.valor || '0');
                                const fileButton = nf.arquivo ? 
                                    `<button onclick="viewPDF('${nf.arquivo}')" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded text-xs transition-colors"><i class="fas fa-file-pdf mr-1"></i>PDF</button>` : '';

                                return `
                                    <div class="flex justify-between items-center bg-gray-900 p-3 rounded-lg border border-gray-700">
                                        <div class="flex flex-col">
                                            <span class="font-semibold text-white text-sm">NF: ${nf.numero || 'N/A'}</span>
                                        </div>
                                        <div class="flex items-center gap-4">
                                            <span class="text-green-400 font-extrabold text-sm">R$ ${nfValor}</span>
                                            ${fileButton}
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                `;
            });
            
            return html;
        }

        function calcularValorNF(valor) {
            // Valor vem como n√∫mero do backend
            const v = typeof valor === 'number' ? valor : parseFloat(valor) || 0;
            return v.toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2});
        }

        function renderAgendamentoDetalhes(data) {
            currentAgendamento = data;
            document.getElementById('display-codigo').textContent = data.codigo || 'N/A';
            document.getElementById('display-codigo').classList.remove('animate-pulse');

            const buttonsHTML = renderActionButtons(data);
            const communicationHistoryHTML = renderCommunicationHistory(data);
            const nfsHTML = renderPedidosENotasFiscais(data);

            // Novo layout: grid dash sem scroll, cards lado a lado
            const detailsHTML = `
                <div class="grid grid-cols-2 gap-8 items-stretch">
                    <div class="card-detail p-6 rounded-2xl flex flex-col gap-4 border-orange-primary/30">
                        <h2 class="text-2xl font-black text-white mb-2 flex items-center gap-2">
                            <i class="fas ${statusMap[data.status]?.icon || 'fa-info-circle'} text-orange-primary"></i>
                            ${statusMap[data.status]?.text || 'Status'}
                        </h2>
                        <p class="text-text-secondary mb-2">${statusMap[data.status]?.description || ''}</p>
                        <div class="flex flex-wrap gap-2">${buttonsHTML}</div>
                    </div>
                    <div class="card-detail p-6 rounded-2xl flex flex-col gap-4">
                        <h3 class="text-xl font-bold text-white mb-2 flex items-center gap-2">
                            <i class="fas fa-calendar-alt text-orange-primary"></i> Agendamento & CD
                        </h3>
                        <div class="space-y-2 text-sm">
                            <div><span class="text-text-secondary">Data Solicitada:</span> <span class="font-semibold text-gray-light">${formatDateBrFromISO(data.dataEntrega)}</span></div>
                            <div><span class="text-text-secondary">Hor√°rio:</span> <span class="font-semibold text-gray-light">${data.horarioEntrega}</span></div>
                            <div><span class="text-text-secondary">CD Destino:</span> <span class="font-extrabold text-orange-secondary">${data.cdDestino || 'N/A'}</span></div>
                            <div><span class="text-text-secondary">Cria√ß√£o:</span> <span class="font-semibold text-gray-light">${formatDateBrFromISO(data.dataCriacao)}</span></div>
                        </div>
                    </div>
                    <div class="card-detail p-6 rounded-2xl flex flex-col gap-4">
                        <h3 class="text-xl font-bold text-white mb-2 flex items-center gap-2">
                            <i class="fas fa-truck-moving text-blue-400"></i> Transportador
                        </h3>
                        <div class="space-y-2 text-sm">
                            <div><span class="text-text-secondary">Empresa:</span> <span class="font-semibold text-gray-light">${data.fornecedor?.nome || 'N/A'}</span></div>
                            <div><span class="text-text-secondary">CNPJ:</span> <span class="font-semibold text-gray-light">${data.fornecedor?.documento || 'N/A'}</span></div>
                            <div><span class="text-text-secondary">Contato:</span> <span class="font-semibold text-gray-light truncate" title="${data.fornecedor?.email || 'N/A'}">${data.fornecedor?.email || 'N/A'}</span></div>
                            <div class="border-t border-border-dark/50 pt-2 mt-2">
                                <p class="font-semibold text-orange-400 mb-1">Motorista & Ve√≠culo</p>
                                <div><span class="text-text-secondary">Motorista:</span> <span class="font-semibold text-gray-light">${data.motoristaNome || 'N/A'}</span></div>
                                <div><span class="text-text-secondary">Placa / Tipo:</span> <span class="font-bold text-orange-secondary">${data.placaVeiculo || 'N/A'} / ${data.tipoVeiculo || 'N/A'}</span></div>
                            </div>
                        </div>
                    </div>
                    <div class="card-detail p-6 rounded-2xl flex flex-col gap-4">
                        <h3 class="text-xl font-bold text-white mb-2 flex items-center gap-2">
                            <i class="fas fa-calculator text-green-400"></i> Resumo Financeiro
                        </h3>
                        <div class="space-y-2 text-sm">
                            <div class="flex justify-between"><span class="text-text-secondary">Total de Pedidos:</span> <span class="font-bold text-white">${data.pedidos?.length || 0}</span></div>
                            <div class="flex justify-between"><span class="text-text-secondary">Total de Notas Fiscais:</span> <span class="font-bold text-white">${data.pedidos?.reduce((acc, p) => acc + (p.notasFiscais?.length || 0), 0) || 0}</span></div>
                            <div class="flex justify-between"><span class="text-text-secondary">Valor Total Estimado:</span> <span class="font-black text-green-400">R$ ${calcularValorTotal(data)}</span></div>
                        </div>
                    </div>
                    <div class="card-detail p-6 rounded-2xl flex flex-col gap-4 col-span-2">
                        <h3 class="text-xl font-bold text-white mb-2 flex items-center gap-2">
                            <i class="fas fa-file-invoice-dollar text-green-400"></i> Itens Detalhados da Entrega
                        </h3>
                        ${nfsHTML}
                    </div>
                    <div class="card-detail p-6 rounded-2xl flex flex-col gap-4 col-span-2">
                        <h3 class="text-xl font-bold text-white mb-2 flex items-center gap-2">
                            <i class="fas fa-timeline-ol text-yellow-400"></i> Comunica√ß√£o e Hist√≥rico
                        </h3>
                        ${communicationHistoryHTML}
                    </div>
                    ${data.observacoes ? `
                        <div class="card-detail p-6 rounded-2xl flex flex-col gap-4 col-span-2">
                            <h3 class="text-xl font-bold text-white mb-2 flex items-center gap-2">
                                <i class="fas fa-comment-alt text-gray-500"></i> Observa√ß√µes
                            </h3>
                            <p class="text-text-secondary bg-bg-dark p-4 rounded-lg border border-border-dark">${data.observacoes}</p>
                        </div>
                    ` : ''}
                </div>
            `;
            document.getElementById('agendamento-detalhes').innerHTML = detailsHTML;
        }

        async function fetchAgendamentoAndRender(codigo) {
            document.getElementById('display-codigo').textContent = codigo;
            document.getElementById('display-codigo').classList.add('animate-pulse');
            const agendamentoDiv = document.getElementById('agendamento-detalhes');
            agendamentoDiv.innerHTML = `<div class="card-detail text-center p-10"><p class="text-xl text-orange-400"><i class="fas fa-spinner fa-spin mr-2"></i>Buscando detalhes para ${codigo}...</p></div>`;

            try {
                await new Promise(resolve => setTimeout(resolve, 500));

                const response = await fetch(`${API_BASE_URL}/api/agendamentos/consultar/${codigo}`);
                let result = null;
                let errorMsg = '';
                if (!response.ok) {
                    errorMsg = `Erro HTTP ${response.status}: ${response.statusText}`;
                } else {
                    try {
                        result = await response.json();
                    } catch (jsonError) {
                        errorMsg = 'Resposta da API est√° malformada.';
                    }
                }

                if (result && result.success && result.data) {
                    renderAgendamentoDetalhes(result.data);
                } else {
                    let apiError = (result && (result.error || result.message)) ? (result.error || result.message) : errorMsg;
                    agendamentoDiv.innerHTML = `<div class="card-detail text-center p-10 bg-red-900/30 border-red-700 text-red-400"><i class="fas fa-times-circle mr-2"></i>Agendamento ${codigo} n√£o encontrado.<br>${apiError ? `<br><span class='text-xs'>${apiError}</span>` : ''}</div>`;
                    showNotification(`Agendamento ${codigo} n√£o encontrado. ${apiError ? apiError : ''}`, 'error');
                }
            } catch (error) {
                agendamentoDiv.innerHTML = `<div class="card-detail text-center p-10 bg-red-900/30 border-red-700 text-red-400"><i class="fas fa-exclamation-triangle mr-2"></i>Erro ao consultar o agendamento. Verifique a conex√£o com a API.<br><span class='text-xs'>${error.message}</span></div>`;
                showNotification('Erro de conex√£o com a API. ' + error.message, 'error');
            }
        }

        function init() {
            const codigo = new URLSearchParams(window.location.search).get('codigo');
            if (codigo) {
                fetchAgendamentoAndRender(codigo);
            } else {
                document.getElementById('agendamento-detalhes').innerHTML = `
                    <div class="card-detail text-center p-12 rounded-2xl shadow-deep space-y-4">
                        <i class="fas fa-route text-6xl text-orange-primary mb-4 animate-float"></i>
                        <h2 class="text-3xl font-bold text-white">Nenhum C√≥digo Fornecido</h2>
                        <p class="text-lg text-text-secondary">Utilize o bot√£o **Consultar outro** na barra de navega√ß√£o superior para inserir o c√≥digo de agendamento e ver os detalhes.</p>
                    </div>
                `;
            }
            
            document.getElementById('consulta-form')?.addEventListener('submit', function(e) {
                e.preventDefault();
                const codigoInput = document.getElementById('codigo-consulta').value.trim();
                // Valida√ß√£o de placa no step 1 (se existir campo de placa)
                const placaInput = document.getElementById('placaVeiculo');
                if (placaInput) {
                    const placa = placaInput.value.trim().toUpperCase();
                    // Regex: AAA1A11 ou AAA1111
                    const regex = /^[A-Z]{3}\d{1}[A-Z]{1}\d{2}$|^[A-Z]{3}\d{4}$/;
                    if (!regex.test(placa)) {
                        showNotification('A placa est√° fora do padr√£o permitido (AAA1A11 ou AAA1111).', 'error');
                        placaInput.focus();
                        return;
                    }
                }
                if (codigoInput) {
                    closeConsultaModal();
                    window.location.href = `consultar-agendamento.html?codigo=${encodeURIComponent(codigoInput)}`;
                }
            });
            document.getElementById('form-cancelar-solicitacao')?.addEventListener('submit', enviarMotivoCancelamento);
            document.getElementById('contra-proposta-form')?.addEventListener('submit', enviarContraProposta);

            document.addEventListener('click', (e) => {
                if (e.target.classList.contains('modal-backdrop')) {
                    if (!document.getElementById('consulta-modal').classList.contains('hidden')) { closeConsultaModal(); }
                    if (!document.getElementById('cancelar-solicitacao-modal').classList.contains('hidden')) { fecharCancelarSolicitacaoModal(); }
                    if (!document.getElementById('contra-proposta-modal').classList.contains('hidden')) { fecharContraPropostaModal(); }
                }
            });
        }

        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>