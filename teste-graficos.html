<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste de Gráficos - BrisaLOG</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="js/chart-error-handler.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            max-width: 1200px;
            margin: 0 auto;
        }
        .container {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
        }
        .chart-container {
            flex: 1;
            min-width: 300px;
            height: 300px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .chart-container h3 {
            margin-top: 0;
            color: #FF6B35;
        }
        .controls {
            margin-bottom: 20px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background-color: #f9f9f9;
        }
        button {
            background-color: #FF6B35;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 10px;
        }
        button:hover {
            background-color: #FF8C42;
        }
    </style>
</head>
<body>
    <h1>Teste de Gráficos - BrisaLOG</h1>
    <p>Esta página testa a renderização de gráficos para identificar problemas com o Chart.js</p>

    <div class="controls">
        <button id="btn-criar">Criar Gráficos</button>
        <button id="btn-destruir">Destruir Gráficos</button>
        <button id="btn-recriar">Recriar Gráficos</button>
    </div>

    <div class="container">
        <div class="chart-container">
            <h3>Gráfico de Status</h3>
            <div id="grafico-status"></div>
        </div>
        <div class="chart-container">
            <h3>Gráfico por Dia da Semana</h3>
            <div id="grafico-dia-semana"></div>
        </div>
    </div>
    <div class="container">
        <div class="chart-container">
            <h3>Gráfico de Tendência</h3>
            <div id="grafico-tendencia"></div>
        </div>
        <div class="chart-container">
            <h3>Gráfico de Horários</h3>
            <div id="grafico-horarios"></div>
        </div>
    </div>

    <script>
        // Dados de exemplo
        const statusData = {
            pendente: 45,
            confirmado: 35,
            entregue: 65,
            'nao-veio': 20,
            reagendamento: 15,
            cancelado: 10,
            aguardando: 5,
            desconhecido: 2
        };
        
        const diasSemanaData = {
            0: 10, // Domingo
            1: 45, // Segunda
            2: 38, // Terça
            3: 50, // Quarta
            4: 42, // Quinta
            5: 35, // Sexta
            6: 15  // Sábado
        };
        
        // Referências globais para os gráficos
        let graficoStatus = null;
        let graficoDiaSemana = null;
        let graficoTendencia = null;
        let graficoHorarios = null;
        
        // Função auxiliar para criar gráficos com segurança
        function criarGraficoSeguro(elementId, callback) {
            const container = document.getElementById(elementId);
            if (!container) {
                console.warn(`Elemento ${elementId} não encontrado`);
                return false;
            }

            // Limpar conteúdo anterior
            container.innerHTML = '';
            
            // Criar novo canvas
            const canvas = document.createElement('canvas');
            container.appendChild(canvas);
            
            // Verificar se o canvas está no DOM
            if (!canvas.parentNode) {
                console.error(`Falha ao anexar canvas ao elemento ${elementId}`);
                return false;
            }
            
            try {
                return callback(canvas);
            } catch (error) {
                console.error(`Erro ao renderizar gráfico em ${elementId}:`, error);
                container.innerHTML = `
                    <div style="text-align: center; padding: 20px; color: #666;">
                        <p>Não foi possível carregar o gráfico</p>
                        <p>${error.message}</p>
                    </div>
                `;
                return false;
            }
        }

        // Funções de renderização
        function renderizarGraficoStatus() {
            // Destruir gráfico existente se houver
            if (graficoStatus instanceof Chart) {
                graficoStatus.destroy();
                graficoStatus = null;
            }

            return criarGraficoSeguro('grafico-status', (canvas) => {
                // Cores do tema
                const cores = {
                    pendente: '#ff8c00',      // Laranja
                    confirmado: '#4caf50',    // Verde
                    entregue: '#2196f3',      // Azul
                    'nao-veio': '#f44336',    // Vermelho
                    reagendamento: '#9c27b0'  // Roxo
                };
                
                graficoStatus = new Chart(canvas, {
                    type: 'doughnut',
                    data: {
                        labels: ['Pendente', 'Confirmado', 'Entregue', 'Não Veio', 'Reagendamento'],
                        datasets: [{
                            data: [
                                statusData.pendente,
                                statusData.confirmado,
                                statusData.entregue,
                                statusData['nao-veio'],
                                statusData.reagendamento
                            ],
                            backgroundColor: [
                                cores.pendente,
                                cores.confirmado,
                                cores.entregue,
                                cores['nao-veio'],
                                cores.reagendamento
                            ],
                            borderWidth: 2,
                            borderColor: '#ffffff'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        cutout: '60%',
                        plugins: {
                            legend: {
                                position: 'right',
                                labels: {
                                    color: '#333333',
                                    padding: 10,
                                    font: {
                                        size: 11
                                    }
                                }
                            },
                            title: {
                                display: true,
                                text: 'Distribuição por Status',
                                color: '#333333',
                                font: {
                                    size: 14,
                                    weight: 'bold'
                                },
                                padding: {
                                    top: 10,
                                    bottom: 15
                                }
                            }
                        }
                    }
                });
                
                return graficoStatus;
            });
        }

        function renderizarGraficoDiaSemana() {
            // Destruir gráfico existente se houver
            if (graficoDiaSemana instanceof Chart) {
                graficoDiaSemana.destroy();
                graficoDiaSemana = null;
            }

            return criarGraficoSeguro('grafico-dia-semana', (canvas) => {
                graficoDiaSemana = new Chart(canvas, {
                    type: 'bar',
                    data: {
                        labels: ['Dom', 'Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'Sáb'],
                        datasets: [{
                            label: 'Agendamentos',
                            data: [
                                diasSemanaData[0],
                                diasSemanaData[1],
                                diasSemanaData[2],
                                diasSemanaData[3],
                                diasSemanaData[4],
                                diasSemanaData[5],
                                diasSemanaData[6]
                            ],
                            backgroundColor: '#ff8c00',
                            borderColor: '#e67e00',
                            borderWidth: 1,
                            borderRadius: 4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                grid: {
                                    color: 'rgba(0, 0, 0, 0.05)'
                                },
                                ticks: {
                                    precision: 0,
                                    color: '#666666'
                                }
                            },
                            x: {
                                grid: {
                                    display: false
                                },
                                ticks: {
                                    color: '#666666'
                                }
                            }
                        },
                        plugins: {
                            legend: {
                                display: false
                            },
                            title: {
                                display: true,
                                text: 'Volume por Dia da Semana',
                                color: '#666666',
                                font: {
                                    size: 14,
                                    weight: 'bold'
                                },
                                padding: {
                                    top: 10,
                                    bottom: 15
                                }
                            }
                        }
                    }
                });
                
                return graficoDiaSemana;
            });
        }

        function renderizarGraficoTendencia() {
            // Destruir gráfico existente se houver
            if (graficoTendencia instanceof Chart) {
                graficoTendencia.destroy();
                graficoTendencia = null;
            }

            return criarGraficoSeguro('grafico-tendencia', (canvas) => {
                // Dados de exemplo para tendência
                const labels = ['Semana 1', 'Semana 2', 'Semana 3', 'Semana 4'];
                const totais = [120, 150, 140, 180];
                const taxas = [85, 82, 88, 90];
                
                graficoTendencia = new Chart(canvas, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [
                            {
                                label: 'Total Agendamentos',
                                data: totais,
                                borderColor: '#ff8c00',
                                backgroundColor: 'rgba(255, 140, 0, 0.1)',
                                borderWidth: 2,
                                fill: true,
                                tension: 0.3,
                                yAxisID: 'y'
                            },
                            {
                                label: 'Taxa de Entrega (%)',
                                data: taxas,
                                borderColor: '#4caf50',
                                backgroundColor: 'transparent',
                                borderWidth: 2,
                                tension: 0.3,
                                yAxisID: 'y1'
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                position: 'left',
                                grid: {
                                    color: 'rgba(0, 0, 0, 0.05)'
                                },
                                ticks: {
                                    precision: 0,
                                    color: '#666666'
                                },
                                title: {
                                    display: true,
                                    text: 'Quantidade',
                                    color: '#666666'
                                }
                            },
                            y1: {
                                beginAtZero: true,
                                position: 'right',
                                grid: {
                                    display: false
                                },
                                max: 100,
                                ticks: {
                                    callback: function(value) {
                                        return value + '%';
                                    },
                                    color: '#666666'
                                },
                                title: {
                                    display: true,
                                    text: 'Taxa',
                                    color: '#666666'
                                }
                            }
                        },
                        plugins: {
                            legend: {
                                position: 'top',
                                labels: {
                                    color: '#666666',
                                    padding: 10,
                                    usePointStyle: true,
                                    pointStyle: 'circle'
                                }
                            },
                            title: {
                                display: true,
                                text: 'Tendência de Entregas',
                                color: '#333333',
                                font: {
                                    size: 14,
                                    weight: 'bold'
                                },
                                padding: {
                                    top: 10,
                                    bottom: 15
                                }
                            }
                        }
                    }
                });
                
                return graficoTendencia;
            });
        }

        function renderizarGraficoHorarios() {
            // Destruir gráfico existente se houver
            if (graficoHorarios instanceof Chart) {
                graficoHorarios.destroy();
                graficoHorarios = null;
            }

            return criarGraficoSeguro('grafico-horarios', (canvas) => {
                // Dados de exemplo para horários
                const horarios = ['08:00', '09:00', '10:00', '11:00', '12:00', '13:00', '14:00', '15:00', '16:00', '17:00'];
                const dados = [15, 28, 32, 25, 10, 18, 22, 30, 27, 12];
                const taxaEntrega = [90, 85, 88, 92, 70, 75, 82, 88, 95, 80];
                
                graficoHorarios = new Chart(canvas, {
                    type: 'bar',
                    data: {
                        labels: horarios,
                        datasets: [
                            {
                                label: 'Agendamentos',
                                data: dados,
                                backgroundColor: 'rgba(255, 140, 0, 0.7)',
                                borderColor: 'rgba(255, 140, 0, 1)',
                                borderWidth: 1,
                                borderRadius: 4,
                                order: 1
                            },
                            {
                                label: 'Taxa de Entrega (%)',
                                data: taxaEntrega,
                                type: 'line',
                                borderColor: '#4caf50',
                                backgroundColor: 'transparent',
                                borderWidth: 2,
                                pointBackgroundColor: '#4caf50',
                                pointRadius: 3,
                                tension: 0.3,
                                yAxisID: 'y1',
                                order: 0
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                position: 'left',
                                grid: {
                                    color: 'rgba(0, 0, 0, 0.05)'
                                },
                                ticks: {
                                    precision: 0,
                                    color: '#666666'
                                }
                            },
                            y1: {
                                beginAtZero: true,
                                position: 'right',
                                grid: {
                                    display: false
                                },
                                max: 100,
                                ticks: {
                                    callback: function(value) {
                                        return value + '%';
                                    },
                                    color: '#666666'
                                }
                            }
                        },
                        plugins: {
                            legend: {
                                position: 'top',
                                labels: {
                                    color: '#666666'
                                }
                            },
                            title: {
                                display: true,
                                text: 'Distribuição por Horário',
                                color: '#333333',
                                font: {
                                    size: 14,
                                    weight: 'bold'
                                }
                            }
                        }
                    }
                });
                
                return graficoHorarios;
            });
        }

        // Função para criar todos os gráficos
        function criarGraficos() {
            renderizarGraficoStatus();
            renderizarGraficoDiaSemana();
            renderizarGraficoTendencia();
            renderizarGraficoHorarios();
        }

        // Função para destruir todos os gráficos
        function destruirGraficos() {
            if (graficoStatus) {
                graficoStatus.destroy();
                graficoStatus = null;
            }
            
            if (graficoDiaSemana) {
                graficoDiaSemana.destroy();
                graficoDiaSemana = null;
            }
            
            if (graficoTendencia) {
                graficoTendencia.destroy();
                graficoTendencia = null;
            }
            
            if (graficoHorarios) {
                graficoHorarios.destroy();
                graficoHorarios = null;
            }
            
            // Limpar os containers
            document.getElementById('grafico-status').innerHTML = '';
            document.getElementById('grafico-dia-semana').innerHTML = '';
            document.getElementById('grafico-tendencia').innerHTML = '';
            document.getElementById('grafico-horarios').innerHTML = '';
        }

        // Função para recriar gráficos (útil para testar problemas de contexto)
        function recriarGraficos() {
            destruirGraficos();
            setTimeout(criarGraficos, 100); // Pequeno atraso para garantir que a destruição foi concluída
        }

        // Adicionar eventos aos botões
        document.getElementById('btn-criar').addEventListener('click', criarGraficos);
        document.getElementById('btn-destruir').addEventListener('click', destruirGraficos);
        document.getElementById('btn-recriar').addEventListener('click', recriarGraficos);

        // Criar gráficos quando a página carregar
        document.addEventListener('DOMContentLoaded', criarGraficos);
    </script>
</body>
</html>
