<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Agendamento de Entrega - BrisaLOG Portal</title>


  <script src="config.js"></script>
  <script src="js/apiRequest.js"></script>

  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <!-- Flatpickr CSS -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <!-- Flatpickr JS -->
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            'orange-primary': '#FF6B35',
            'orange-secondary': '#FF8C42',
            'orange-accent': '#FF9F66',
            'orange-light': '#FFA885',
            'gray-dark': '#2D3748',
            'gray-medium': '#4A5568',
            'gray-light': '#E2E8F0',
            'background': 'hsl(0,0%,98%)',
            'card': 'hsl(0,0%,100%)',
            'primary': 'hsl(14,100%,60%)',
            'secondary': 'hsl(16,100%,63%)',
            'accent': 'hsl(16,100%,70%)',
            'muted': 'hsl(210,40%,96.1%)',
            'destructive': 'hsl(0,84%,60%)',
            'border': 'hsl(214,32%,91%)',
            'input': 'hsl(214,32%,91%)',
            'ring': 'hsl(14,100%,60%)'
          },
          borderRadius: {
            DEFAULT: '0.75rem',
            md: 'calc(0.75rem - 2px)',
            lg: 'calc(0.75rem + 2px)'
          },
          boxShadow: {
            soft: '0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1)',
            medium: '0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1)',
            large: '0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1)'
          }
        }
      }
    }
  </script>

  <style>
  :root {
    --background: hsl(0,0%,98%);
    --foreground: hsl(214,31%,21%);
    --card: hsl(0,0%,100%);
    --card-foreground: hsl(214,31%,21%);
    --primary: hsl(14,100%,60%);
    --primary-foreground: hsl(0,0%,100%);
    --secondary: hsl(16,100%,63%);
    --secondary-foreground: hsl(0,0%,100%);
    --accent: hsl(16,100%,70%);
    --accent-foreground: hsl(214,31%,21%);
    --muted: hsl(210,40%,96.1%);
    --muted-foreground: hsl(215,16%,47%);
    --destructive: hsl(0,84%,60%);
    --destructive-foreground: hsl(0,0%,100%);
    --border: hsl(214,32%,91%);
    --input: hsl(214,32%,91%);
    /* Adicionado HSL para o ring-opacity funcionar no CSS */
    --ring-hsl: 14, 100%, 60%; 
    --ring: hsl(var(--ring-hsl));
    --radius: 0.75rem;
    --gradient-primary: linear-gradient(135deg, hsl(14,100%,60%), hsl(16,100%,63%));
    --gradient-warm: linear-gradient(135deg, hsl(16,100%,63%), hsl(16,100%,70%));
    --shadow-soft: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
    --shadow-medium: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
    --shadow-large: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1);
    --transition-smooth: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  }
  .card-3d { transition: all 0.3s ease; box-shadow: var(--shadow-large); border-radius: 1.5rem; border: 1px solid var(--border); }
  .btn-3d { transition: all 0.3s ease; box-shadow: var(--shadow-soft); border-radius: var(--radius); font-weight: 600; }
  .btn-3d:hover { box-shadow: var(--shadow-medium); }
  .gradient-bg { background: var(--gradient-primary); }
  .step-inactive { opacity: .5; pointer-events: none; }
  .step-completed { background: linear-gradient(135deg, #10B981, #059669); }
  .progress-bar { transition: width .5s ease; }
  .notification { position: fixed; top: 20px; right: 20px; z-index: 1000; transform: translateX(400px); transition: transform .3s ease; }
  .notification.show { transform: translateX(0); }
  .file-drop-zone { border: 2px dashed var(--accent); transition: all .3s ease; border-radius: var(--radius); background: #fff; }
  .file-drop-zone.drag-over { border-color: var(--primary); background-color: #FFF5F3; transform: scale(1.02); }
  .nf-card { background: #fff; border-radius: 1.25rem; box-shadow: var(--shadow-soft); border: 1px solid var(--border); padding: 1.5rem; margin-bottom: 1.5rem; }
  .nf-header { font-size: 1.1rem; font-weight: 700; color: var(--primary); display: flex; align-items: center; gap: 0.5rem; margin-bottom: 1rem; }
  
  /* .nf-input (substituído pela classe .input-themed) */
  .nf-trash { color: #e53e3e; background: #fff; border: none; border-radius: 50%; width: 2.5rem; height: 2.5rem; display: flex; align-items: center; justify-content: center; box-shadow: var(--shadow-soft); transition: background .2s; }
  .nf-trash:hover { background: #ffe5e5; }
  .nf-summary { background: #fff; border-radius: 1.5rem; box-shadow: var(--shadow-soft); border: 1px solid var(--border); padding: 2rem; margin-top: 2rem; }
  .nf-summary-title { font-size: 1.3rem; font-weight: 700; color: #059669; display: flex; align-items: center; gap: 0.5rem; margin-bottom: 1.5rem; }
  .nf-summary-section { margin-bottom: 1.5rem; }
  .nf-summary-label { font-weight: 600; color: var(--muted-foreground); margin-bottom: 0.25rem; font-size: 0.9rem; }
  .nf-summary-value { font-size: 1.1rem; color: var(--foreground); font-weight: 500; }

  /* * NOVO: Classes de Input Padronizadas (Objetivo 2)
  * Usam as variáveis CSS do seu tema para animação e cores.
  */
  .input-themed {
    width: 100%;
    padding: 0.75rem 1rem; /* py-3 px-4 */
    border: 1px solid var(--border);
    border-radius: var(--radius); /* rounded-lg */
    background-color: var(--card); /* bg-white */
    color: var(--foreground);
    transition: var(--transition-smooth);
    font-size: 1rem;
  }
  .input-themed::placeholder {
    color: var(--muted-foreground);
    opacity: 0.8;
  }
  .input-themed:focus,
  .input-themed:focus-within {
    outline: none;
    border-color: var(--primary);
    /* Sombra com cor e opacidade do tema */
    box-shadow: 0 0 0 2px hsla(var(--ring-hsl), 0.2); 
  }

  /* Adiciona a seta para <select> */
  .select-themed {
    -webkit-appearance: none;
    -moz-appearance: none;
    appearance: none;
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3E%3Cpath stroke='%236B7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='m6 8 4 4 4-4'/%3E%3C/svg%3E");
    background-position: right 0.75rem center;
    background-repeat: no-repeat;
    background-size: 1.25em 1.25em;
    padding-right: 2.5rem; /* Espaço para a seta */
  }

  /* Ajuste para o input[type=file] customizado */
  .file-input-wrapper {
    position: relative;
  }
  .file-input-label {
    display: flex;
    align-items: center;
    justify-content: space-between;
    cursor: pointer;
    overflow: hidden; /* Garante que o span.file-name não quebre o layout */
  }
  .file-input-label span.file-name {
    text-overflow: ellipsis;
    white-space: nowrap;
    overflow: hidden;
    color: var(--muted-foreground);
  }
  .file-input-label.file-selected span.file.name {
    color: var(--foreground); /* Texto normal quando selecionado */
  }
  .file-input-native {
    position: absolute;
    inset: 0;
    width: 100%;
    height: 100%;
    opacity: 0;
    cursor: pointer;
  }
  .glass-nav {
      background: linear-gradient(90deg, #FF6B35 80%, #FF8C42 100%);
      border-bottom: 1px solid rgba(255, 107, 53, 0.2);
      color: #fff;
    }
    .glass-nav h1, .glass-nav p {
      color: #fff !important;
    }
    .glass-nav .text-gray-400 {
      color: #fff !important;
    }
    #page-transition {
      transition: opacity 0.5s;
    }
  </style>
</head>
<body class="bg-gray-50 min-h-screen font-[Inter]">
    <div id="page-transition" style="position:fixed;top:0;left:0;width:100vw;height:100vh;background:#181818;opacity:1;pointer-events:auto;z-index:9999;transition:opacity 0.5s;"></div>
  <header class="glass-nav sticky top-0 z-50">
    <nav class="max-w-7xl mx-auto px-6 py-4">
      <div class="flex items-center justify-between">
        <div class="flex items-center space-x-3">
          <div class="w-12 h-12 bg-gradient-to-br from-orange-500 to-orange-600 rounded-xl flex items-center justify-center">
            <i class="fas fa-truck text-white text-2xl"></i>
          </div>
          <div>
            <h1 class="text-xl font-bold text-white">BrisaLOG</h1>
            <p class="text-xs text-white">Agendamento de Entrega</p>
          </div>
        </div>
        <a href="/" class="flex items-center text-white hover:text-orange-200 transition-colors" id="btn-voltar">
          <i class="fas fa-home mr-2"></i>
          Voltar ao Início
        </a>
      </div>
    </nav>
  </header>

  <div class="bg-white border-b">
    <div class="container mx-auto px-6 py-4">
      <div class="flex items-center justify-between mb-4">
        <div class="flex items-center space-x-4">
          <div id="step-1" class="step flex items-center justify-center w-10 h-10 rounded-full bg-orange-primary text-white font-bold">1</div>
          <div class="h-1 w-16 bg-gray-300">
            <div id="progress-1-2" class="h-full bg-orange-primary progress-bar" style="width: 0%"></div>
          </div>
          <div id="step-2" class="step flex items-center justify-center w-10 h-10 rounded-full bg-gray-300 text-gray-500 font-bold">2</div>
          <div class="h-1 w-16 bg-gray-300">
            <div id="progress-2-3" class="h-full bg-orange-primary progress-bar" style="width: 0%"></div>
          </div>
          <div id="step-3" class="step flex items-center justify-center w-10 h-10 rounded-full bg-gray-300 text-gray-500 font-bold">3</div>
          <div class="h-1 w-16 bg-gray-300">
            <div id="progress-3-4" class="h-full bg-orange-primary progress-bar" style="width: 0%"></div>
          </div>
          <div id="step-4" class="step flex items-center justify-center w-10 h-10 rounded-full bg-gray-300 text-gray-500 font-bold">4</div>
        </div>
        <div class="text-right">
          <p class="text-sm text-gray-medium">Etapa <span id="current-step">1</span> de 4</p>
          <p class="text-xs text-gray-400" id="step-description">Dados do Transportador</p>
        </div>
      </div>
    </div>
  </div>

  <main class="container mx-auto px-6 py-8">
    <div class="max-w-4xl mx-auto">
      <form id="agendamento-form">
        <div id="form-step-1" class="form-step">
          <div class="bg-white rounded-2xl shadow-xl p-8 card-3d">
            <div class="text-center mb-8">
              <div class="bg-gradient-to-r from-orange-primary to-orange-secondary p-4 rounded-2xl inline-block mb-4">
                <i class="fas fa-user text-white text-3xl"></i>
              </div>
              <h2 class="text-3xl font-bold text-gray-dark mb-2">Dados do Transportador</h2>
              <p class="text-gray-medium">Informe os dados para identificação da entrega</p>
            </div>

            <div class="grid md:grid-cols-2 gap-6">

              <div>
                <label class="block text-gray-dark font-semibold mb-2">
                  <i class="fas fa-building mr-2 text-orange-primary"></i>
                  Nome do Transportador *
                </label>
                <input type="text" id="nome-empresa" name="nomeEmpresa" required
                  class="input-themed"
                  placeholder="Nome da empresa transportadora">
                <div class="invalid-feedback hidden text-red-500 text-sm mt-1"></div>
              </div>
              <div>
                <label class="block text-gray-dark font-semibold mb-2">
                  <i class="fas fa-briefcase mr-2 text-orange-primary"></i>
                  CNPJ da Transportadora *
                </label>
                <input type="text" id="documento" name="documento" required maxlength="18"
                  class="input-themed"
                  placeholder="00.000.000/0000-00">
                <div class="invalid-feedback hidden text-red-500 text-sm mt-1"></div>
              </div>

              <div>
                <label class="block text-gray-dark font-semibold mb-2">
                  <i class="fas fa-envelope mr-2 text-orange-primary"></i>
                  E-mail do Transportador *
                </label>
                <input type="email" id="email" name="email" required
                  class="input-themed"
                  placeholder="email@transportadora.com">
                <div class="invalid-feedback hidden text-red-500 text-sm mt-1"></div>
              </div>
              <div>
                <label class="block text-gray-dark font-semibold mb-2">
                  <i class="fas fa-phone mr-2 text-orange-primary"></i>
                  Telefone da Transportadora *
                </label>
                <input type="tel" id="telefone" name="telefone" required maxlength="15"
                  class="input-themed"
                  placeholder="(00) 00000-0000">
                <div class="invalid-feedback hidden text-red-500 text-sm mt-1"></div>
              </div>

              <div>
                <label class="block text-gray-dark font-semibold mb-2">
                  <i class="fas fa-id-badge mr-2 text-orange-primary"></i>
                  Nome do Motorista *
                </label>
                <input type="text" id="nome-responsavel" name="nomeResponsavel" required
                  class="input-themed"
                  placeholder="Nome do motorista responsável">
                <div class="invalid-feedback hidden text-red-500 text-sm mt-1"></div>
              </div>
              <div>
                <label class="block text-gray-dark font-semibold mb-2">
                  <i class="fas fa-id-card mr-2 text-orange-primary"></i>
                  CPF do Motorista *
                </label>
                <input type="text" id="cpf-motorista" name="cpfMotorista" required maxlength="14"
                  class="input-themed"
                  placeholder="000.000.000-00">
                <div class="invalid-feedback hidden text-red-500 text-sm mt-1"></div>
              </div>

              <div>
                <label class="block text-gray-dark font-semibold mb-2">
                  <i class="fas fa-car-side mr-2 text-orange-primary"></i>
                  Placa do Veículo (CAVALO) *
                </label>
                <input type="text" id="placa-veiculo" name="placaVeiculo" required maxlength="8"
                  class="input-themed"
                  placeholder="AAA0A00">
                <div class="invalid-feedback hidden text-red-500 text-sm mt-1"></div>
              </div>

              <div>
                <label class="block text-gray-dark font-semibold mb-2">
                  <i class="fas fa-truck-moving mr-2 text-orange-primary"></i>
                  Tipo de Veículo *
                </label>
                <select id="tipo-veiculo" name="tipoVeiculo" required class="input-themed select-themed">
                  <option value="" disabled selected>Selecione o tipo de veículo</option>
                  <option>Moto</option>
                  <option>Carro</option>
                  <option>Van</option>
                  <option>3/4</option>
                  <option>Toco</option>
                  <option>Truck</option>
                  <option>Bi-Truck</option>
                  <option>Carreta</option>
                  <option>Bi-Tren</option>
                </select>
                <div class="invalid-feedback hidden text-red-500 text-sm mt-1"></div>
              </div>
              <div>
                <label class="block text-gray-dark font-semibold mb-2">
                  <i class="fas fa-phone mr-2 text-orange-primary"></i>
                  Telefone do Motorista *
                </label>
                <input type="tel" id="telefone-motorista" name="telefoneMotorista" required maxlength="15"
                  class="input-themed"
                  placeholder="(00) 00000-0000">
                <div class="invalid-feedback hidden text-red-500 text-sm mt-1"></div>
              </div>
            </div>

            <div class="flex justify-end mt-8">
              <button type="button" onclick="nextStep()" class="btn-3d bg-orange-primary text-white px-8 py-3 rounded-lg font-semibold hover:bg-orange-secondary transition-all">
                <span>Próximo</span>
                <i class="fas fa-arrow-right ml-2"></i>
              </button>
            </div>
          </div>
        </div>

        <div id="form-step-2" class="form-step hidden">
          <div class="bg-white rounded-2xl shadow-xl p-8 card-3d">
            <div class="text-center mb-8">
              <div class="bg-gradient-to-r from-orange-secondary to-orange-accent p-4 rounded-2xl inline-block mb-4">
                <i class="fas fa-truck text-white text-3xl"></i>
              </div>
              <h2 class="text-3xl font-bold text-gray-dark mb-2">Dados da Entrega</h2>
              <p class="text-gray-medium">Informe os detalhes da sua entrega</p>
            </div>

            <div class="grid md:grid-cols-2 gap-6">
              <div>
                <label class="block text-gray-dark font-semibold mb-2">
                  <i class="fas fa-map-marker-alt mr-2 text-orange-primary"></i>
                  Centro de Distribuição *
                </label>
                <select id="cd-destino" name="cdDestino" required
                  class="input-themed select-themed">
                  <option value="">Selecione o CD</option>
                  <!-- Opções carregadas dinamicamente do banco de dados -->
                </select>
                <div class="invalid-feedback hidden text-red-500 text-sm mt-1"></div>
              </div>

              <!-- Subcategoria CD Lagoa Nova -->
              <div id="subcategoria-cd-container" style="display: none;">
                <label class="block text-gray-dark font-semibold mb-2">
                  <i class="fas fa-building mr-2 text-orange-primary"></i>
                  Destino Específico *
                </label>
                <select id="subcategoria-cd" name="subCategoriaCD" required
                  class="input-themed select-themed">
                  <option value="">Selecione o destino</option>
                  <option value="LagoaNova">CD LAGOA NOVA (SEDE)</option>
                  <option value="pereiro-frota">CD PEREIRO (PEÇAS DE VEICULOS)</option>
                  <option value="cd lagoa nova (torre)">CD LAGOA NOVA (Itens de TORRE)</option>
                </select>
                <div class="invalid-feedback hidden text-red-500 text-sm mt-1"></div>
              </div>

              <div>
                <label class="block text-gray-dark font-semibold mb-2">
                  <i class="fas fa-boxes mr-2 text-orange-primary"></i>
                  Tipo de Carga *
                </label>
                <select id="tipo-carga" name="tipoCarga" required
                  class="input-themed select-themed">
                  <option value="">Selecione o tipo</option>
                  <option value="equipamentos">Equipamentos de Rede</option>
                  <option value="materiais">Materiais de Instalação</option>
                  <option value="componentes">Componentes Eletrônicos</option>
                  <option value="outros">Outros</option>
                </select>
                <div class="invalid-feedback hidden text-red-500 text-sm mt-1"></div>
              </div>

              <div>
                <label class="block text-gray-dark font-semibold mb-2">
                  <i class="fas fa-calendar mr-2 text-orange-primary"></i>
                  Data de Entrega *
                </label>
                <input type="text" id="data-entrega" name="dataEntrega" required
                  class="input-themed" autocomplete="off">
                <div class="invalid-feedback hidden text-red-500 text-sm mt-1"></div>
              </div>

              <div>
                <label class="block text-gray-dark font-semibold mb-2">
                  <i class="fas fa-clock mr-2 text-orange-primary"></i>
                  Horário Preferencial *
                </label>
                
                <!-- Aviso para CD Torre -->
                <div id="aviso-cd-torre" style="display: none;" class="mb-3 p-3 bg-orange-50 border-l-4 border-orange-primary rounded">
                  <div class="flex items-start">
                    <i class="fas fa-info-circle text-orange-primary mt-1 mr-2"></i>
                    <div class="text-sm text-gray-700">
                      <strong>CD Torre:</strong> Apenas 1 agendamento por turno.<br>
                      Escolha <strong>08:00</strong> (turno da manhã) ou <strong>13:00</strong> (turno da tarde).
                    </div>
                  </div>
                </div>
                
                <select id="horario-entrega" name="horarioEntrega" required
                  class="input-themed select-themed">
                  <option value="">Selecione o horário</option>
                  <option value="08:00-10:00">08:00 - 10:00</option>
                  <option value="10:00-12:00">10:00 - 12:00</option>
                  <option value="14:00-16:00">14:00 - 16:00</option>
                  <option value="16:00-17:00">16:00 - 17:00</option>
                </select>
                <div class="invalid-feedback hidden text-red-500 text-sm mt-1"></div>
              </div>

              <div>
                <label class="block text-gray-dark font-semibold mb-2">
                  <i class="fas fa-layer-group mr-2 text-orange-primary"></i>
                  Quantidade de Volumes *
                </label>
                <input type="number" id="quantidade-volumes" name="quantidadeVolumes" min="1" required
                  class="input-themed"
                  placeholder="Informe a quantidade de volumes">
                <div class="invalid-feedback hidden text-red-500 text-sm mt-1"></div>
              </div>

              <div>
                <label class="block text-gray-dark font-semibold mb-2">
                  <i class="fas fa-box mr-2 text-orange-primary"></i>
                  Tipo de Volume *
                </label>
                <select id="tipo-volume" name="tipoVolume" required
                  class="input-themed select-themed">
                  <option value="">Selecione o tipo</option>
                  <option value="palet">Palet</option>
                  <option value="caixa">Caixa</option>
                  <option value="bloco">Bloco</option>
                  <option value="bobina">Bobina</option>
                  <option value="pacote">Pacote</option>
                  <option value="saco">Saco</option>
                  <option value="caixote">Caixote</option>
                  <option value="tambor">Tambor</option>
                </select>
                <div class="invalid-feedback hidden text-red-500 text-sm mt-1"></div>
              </div>

              <div class="md:col-span-2">
                <label class="block text-gray-dark font-semibold mb-2">
                  <i class="fas fa-comment mr-2 text-orange-primary"></i>
                  Observações
                </label>
                <textarea id="observacoes" name="observacoes" rows="3"
                  class="input-themed"
                  placeholder="Informações adicionais sobre a entrega (opcional)"></textarea>
              </div>
            </div>

            <div class="flex justify-between mt-8">
              <button type="button" onclick="previousStep()" class="btn-3d bg-gray-500 text-white px-8 py-3 rounded-lg font-semibold hover:bg-gray-600 transition-all">
                <i class="fas fa-arrow-left mr-2"></i>
                <span>Anterior</span>
              </button>
              <button type="button" onclick="nextStep()" class="btn-3d bg-orange-primary text-white px-8 py-3 rounded-lg font-semibold hover:bg-orange-secondary transition-all">
                <span>Próximo</span>
                <i class="fas fa-arrow-right ml-2"></i>
              </button>
            </div>
          </div>
        </div>

        <div id="form-step-3" class="form-step hidden">
          <div class="bg-white rounded-2xl shadow-xl p-8 card-3d">
            <div class="text-center mb-8">
              <div class="bg-gradient-to-r from-orange-accent to-orange-light p-4 rounded-2xl inline-block mb-4">
                <i class="fas fa-file-invoice text-white text-3xl"></i>
              </div>
              <h2 class="text-3xl font-bold text-gray-dark mb-2">Notas Fiscais</h2>
              <p class="text-gray-medium">Informe as notas e anexe os PDFs</p>
            </div>

            <!-- Instruções de Preenchimento -->
            <div class="bg-blue-50 border-l-4 border-blue-500 rounded-lg p-6 mb-8">
              <div class="flex items-start">
                <div class="flex-shrink-0">
                  <i class="fas fa-info-circle text-blue-500 text-2xl"></i>
                </div>
                <div class="ml-4">
                  <h3 class="text-lg font-bold text-blue-900 mb-3">
                    <i class="fas fa-lightbulb mr-2"></i>Como preencher os dados
                  </h3>
                  <div class="space-y-2 text-sm text-blue-800">
                    <div class="flex items-start">
                      <i class="fas fa-check-circle text-blue-500 mt-1 mr-2 flex-shrink-0"></i>
                      <p><strong>Uma nota fiscal por linha:</strong> Cada linha representa UMA nota fiscal. Se você tiver 3 notas, adicione 3 linhas.</p>
                    </div>
                    <div class="flex items-start">
                      <i class="fas fa-check-circle text-blue-500 mt-1 mr-2 flex-shrink-0"></i>
                      <p><strong>Mesmo pedido, múltiplas notas:</strong> Se um pedido tiver mais de uma nota fiscal, repita o número do pedido em cada linha (uma para cada nota).</p>
                    </div>
                    <div class="flex items-start">
                      <i class="fas fa-check-circle text-blue-500 mt-1 mr-2 flex-shrink-0"></i>
                      <p><strong>Número do Pedido:</strong> É o número que começa com <span class="font-bold bg-yellow-200 px-2 py-1 rounded">450</span> (exemplo: 4501234567).</p>
                    </div>
                    <div class="flex items-start">
                      <i class="fas fa-check-circle text-blue-500 mt-1 mr-2 flex-shrink-0"></i>
                      <p><strong>Anexo PDF:</strong> Cada nota fiscal deve ter seu arquivo PDF anexado.</p>
                    </div>
                  </div>
                  <div class="mt-4 p-3 bg-blue-100 rounded-lg">
                    <p class="text-xs text-blue-900">
                      <i class="fas fa-example mr-1"></i><strong>Exemplo:</strong> Se você tem o pedido 4501234567 com 2 notas fiscais (NF 111 e NF 222), crie 2 linhas:
                      <br>• Linha 1: NF 111 - Pedido 4501234567 - Valor - PDF
                      <br>• Linha 2: NF 222 - Pedido 4501234567 - Valor - PDF
                    </p>
                  </div>
                </div>
              </div>
            </div>

            <div id="pedidos-container">
              <div id="pedido-unico" class="pedido-content">
                <input type="text" name="numeroPedido" value="UNICO" class="hidden">

                <div class="space-y-6" id="notas-container">
                  
                  <div class="nota-fiscal-item bg-gray-50 border border-border rounded-xl p-6 relative">
                    <button type="button" class="btn-remove-nf nf-trash absolute -top-4 -right-4" title="Remover Nota Fiscal" style="display:none">
                      <i class="fas fa-trash"></i>
                    </button>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 items-end">
                      <div>
                        <label class="block text-gray-dark font-semibold mb-2">Número da Nota Fiscal *</label>
                        <input type="text" name="numeroNF" class="input-themed" placeholder="Ex: 123456" required>
                      </div>
                      <div>
                        <label class="block text-gray-dark font-semibold mb-2">Número do Pedido *</label>
                        <input type="text" name="numeroPedidoLinha" class="input-themed" placeholder="Ex: 4501234567" required maxlength="10" inputmode="numeric" pattern="450[0-9]{7}">
                      </div>
                      <div>
                        <label class="block text-gray-dark font-semibold mb-2">Valor (R$) *</label>
                        <input type="text" name="valorNF" class="input-themed" placeholder="R$ 0,00" required>
                      </div>
                      
                      <div>
                        <label class="block text-gray-dark font-semibold mb-2">Anexo PDF *</label>
                        <div class="file-input-wrapper">
                          <label class="input-themed file-input-label">
                            <span class="file-name">Clique para anexar PDF</span>
                            <i class="fas fa-upload ml-2 text-gray-400"></i>
                          </label>
                          <input type="file" name="arquivoNF" accept=".pdf" class="file-input-native" required>
                        </div>
                      </div>
                    </div>
                  </div>
                  </div>

                <div class="flex justify-between items-center mt-8">
                  <button type="button" id="btn-add-nf" class="btn-3d bg-orange-secondary text-white px-6 py-3 rounded-lg font-semibold hover:bg-orange-primary transition-all">
                    <i class="fas fa-plus mr-2"></i> Adicionar Nota Fiscal
                  </button>
                  <div class="text-right">
                    <p class="text-gray-600 font-semibold">Total Geral:</p>
                    <p id="total-geral-nf" class="text-3xl font-bold text-green-600">R$ 0,00</p>
                  </div>
                </div>
              </div>
            </div>

            <div class="flex justify-between mt-8">
              <button type="button" onclick="previousStep()" class="btn-3d bg-gray-500 text-white px-8 py-3 rounded-lg font-semibold hover:bg-gray-600 transition-all">
                <i class="fas fa-arrow-left mr-2"></i>
                <span>Anterior</span>
              </button>
              <button type="button" onclick="nextStep()" class="btn-3d bg-orange-primary text-white px-8 py-3 rounded-lg font-semibold hover:bg-orange-secondary transition-all">
                <span>Próximo</span>
                <i class="fas fa-arrow-right ml-2"></i>
              </button>
            </div>
          </div>
        </div>

        <div id="form-step-4" class="form-step hidden">
          <div class="bg-white rounded-2xl shadow-xl p-8 card-3d">
            <div class="text-center mb-8">
              <div class="bg-gradient-to-r from-green-500 to-green-600 p-4 rounded-2xl inline-block mb-4">
                <i class="fas fa-check-circle text-white text-3xl"></i>
              </div>
              <h2 class="text-3xl font-bold text-gray-dark mb-2">Resumo do Agendamento</h2>
              <p class="text-gray-medium">Confira todos os dados antes de finalizar</p>
            </div>

            <div id="resumo-agendamento" class="nf-summary !shadow-none !border-none !p-0 !mt-0">
              <div id="resumo-agendamento-content" class="space-y-6">

                <div class="nf-summary-section bg-gray-50 p-6 rounded-xl">
                  <h4 class="nf-summary-title !text-orange-primary">
                    <i class="fas fa-user"></i>
                    Dados do Transportador
                  </h4>
                  <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-4">
                    <div>
                      <p class="nf-summary-label">Empresa</p>
                      <p class="nf-summary-value" id="resumo-nome-empresa"></p>
                    </div>
                    <div>
                      <p class="nf-summary-label">CNPJ</p>
                      <p class="nf-summary-value" id="resumo-documento"></p>
                    </div>
                    <div>
                      <p class="nf-summary-label">E-mail</p>
                      <p class="nf-summary-value" id="resumo-email"></p>
                    </div>
                    <div>
                      <p class="nf-summary-label">Telefone</p>
                      <p class="nf-summary-value" id="resumo-telefone"></p>
                    </div>
                    <div>
                      <p class="nf-summary-label">Motorista</p>
                      <p class="nf-summary-value" id="resumo-nome-responsavel"></p>
                    </div>
                    <div>
                      <p class="nf-summary-label">CPF Motorista</p>
                      <p class="nf-summary-value" id="resumo-cpf-motorista"></p>
                    </div>
                     <div>
                      <p class="nf-summary-label">Placa (Cavalo)</p>
                      <p class="nf-summary-value" id="resumo-placa-veiculo"></p>
                    </div>
                    <div>
                      <p class="nf-summary-label">Telefone Motorista</p>
                      <p class="nf-summary-value" id="resumo-telefone-motorista"></p>
                    </div>
                  </div>
                </div>

                <div class="nf-summary-section bg-gray-50 p-6 rounded-xl">
                  <h4 class="nf-summary-title !text-orange-secondary">
                    <i class="fas fa-truck"></i>
                    Detalhes da Entrega
                  </h4>
                  <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-4">
                    <div>
                      <p class="nf-summary-label">Centro de Distribuição</p>
                      <p class="nf-summary-value" id="resumo-cd-destino"></p>
                    </div>
                    <div>
                      <p class="nf-summary-label">Data de Entrega</p>
                      <p class="nf-summary-value" id="resumo-data-entrega"></p>
                    </div>
                    <div>
                      <p class="nf-summary-label">Horário</p>
                      <p class="nf-summary-value" id="resumo-horario-entrega"></p>
                    </div>
                    <div>
                      <p class="nf-summary-label">Tipo de Carga</p>
                      <p class="nf-summary-value" id="resumo-tipo-carga"></p>
                    </div>
                    <div>
                      <p class="nf-summary-label">Qtd. Volumes</p>
                      <p class="nf-summary-value" id="resumo-quantidade-volumes"></p>
                    </div>
                    <div>
                      <p class="nf-summary-label">Tipo de Volume</p>
                      <p class="nf-summary-value" id="resumo-tipo-volume"></p>
                    </div>
                    <div class="md:col-span-2">
                      <p class="nf-summary-label">Observações</p>
                      <p class="nf-summary-value" id="resumo-observacoes"></p>
                    </div>
                  </div>
                </div>

                <div class="nf-summary-section bg-gray-50 p-6 rounded-xl">
                  <h4 class="nf-summary-title !text-green-600">
                    <i class="fas fa-file-invoice"></i>
                    Resumo das Notas
                  </h4>
                  <div id="resumo-pedidos-lista" class="space-y-3 mb-4">
                    </div>
                  <hr class="border-border my-4">
                  <div class="flex justify-between items-center">
                    <div>
                      <p class="nf-summary-label">Valor Total</p>
                      <p class="nf-summary-value text-2xl font-bold text-green-600" id="resumo-valor-total"></p>
                    </div>
                     <div>
                      <p class="nf-summary-label">Total de Notas</p>
                      <p class="nf-summary-value text-xl text-right" id="resumo-total-notas"></p>
                    </div>
                  </div>
                </div>

              </div>
            </div>
            <div class="flex justify-between mt-8">
              <button type="button" onclick="previousStep()" class="btn-3d bg-gray-500 text-white px-8 py-3 rounded-lg font-semibold hover:bg-gray-600 transition-all">
                <i class="fas fa-arrow-left mr-2"></i>
                <span>Anterior</span>
              </button>
              <button type="submit" class="btn-3d bg-green-500 text-white px-8 py-3 rounded-lg font-semibold hover:bg-green-600 transition-all">
                <i class="fas fa-paper-plane mr-2"></i>
                <span>Finalizar Agendamento</span>
              </button>
            </div>
          </div>
        </div>
      </form>
    </div>
  </main>

  <div id="notification-container"></div>

  <div id="loading-overlay" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center">
    <div class="bg-white rounded-2xl p-8 text-center">
      <div class="animate-spin rounded-full h-16 w-16 border-b-2 border-orange-primary mx-auto mb-4"></div>
      <p class="text-gray-dark font-semibold">Processando agendamento...</p>
    </div>
  </div>

  <script>

    // Máscara de telefone (celular e fixo)
    function maskPhone(value) {
      value = value.replace(/\D/g, '').substring(0, 11);
      if (value.length === 11) {
        return value.replace(/(\d{2})(\d{5})(\d{4})/, '($1) $2-$3');
      } else if (value.length === 10) {
        return value.replace(/(\d{2})(\d{4})(\d{4})/, '($1) $2-$3');
      } else {
        return value;
      }
    }

    // Máscara de CPF (000.000.000-00)
    function maskCPF(value) {
      value = value.replace(/\D/g, '').substring(0, 11);
      if (value.length === 11) {
        return value.replace(/(\d{3})(\d{3})(\d{3})(\d{2})/, '$1.$2.$3-$4');
      } else {
        return value;
      }
    }

    // Validação de CPF
    function validarCPF(cpf) {
      cpf = cpf.replace(/\D/g, '');
      
      if (cpf.length !== 11) return false;
      
      // Bloquear sequências repetidas
      if (/^(\d)\1{10}$/.test(cpf)) return false;
      
      // Validar dígitos verificadores
      let soma = 0;
      let resto;
      
      for (let i = 1; i <= 9; i++) {
        soma += parseInt(cpf.substring(i-1, i)) * (11 - i);
      }
      
      resto = (soma * 10) % 11;
      if ((resto === 10) || (resto === 11)) resto = 0;
      if (resto !== parseInt(cpf.substring(9, 10))) return false;
      
      soma = 0;
      for (let i = 1; i <= 10; i++) {
        soma += parseInt(cpf.substring(i-1, i)) * (12 - i);
      }
      
      resto = (soma * 10) % 11;
      if ((resto === 10) || (resto === 11)) resto = 0;
      if (resto !== parseInt(cpf.substring(10, 11))) return false;
      
      return true;
    }

    // Máscara de CNPJ (00.000.000/0000-00)
    function maskCNPJ(value) {
      value = value.replace(/\D/g, '').substring(0, 14);
      if (value.length === 14) {
        return value.replace(/(\d{2})(\d{3})(\d{3})(\d{4})(\d{2})/, '$1.$2.$3/$4-$5');
      } else {
        return value;
      }
    }

    // Validação de CNPJ
    function validarCNPJ(cnpj) {
      cnpj = cnpj.replace(/\D/g, '');
      
      if (cnpj.length !== 14) return false;
      
      // Bloquear sequências repetidas
      if (/^(\d)\1{13}$/.test(cnpj)) return false;
      
      // Validar dígitos verificadores
      let tamanho = cnpj.length - 2;
      let numeros = cnpj.substring(0, tamanho);
      let digitos = cnpj.substring(tamanho);
      let soma = 0;
      let pos = tamanho - 7;
      
      for (let i = tamanho; i >= 1; i--) {
        soma += numeros.charAt(tamanho - i) * pos--;
        if (pos < 2) pos = 9;
      }
      
      let resultado = soma % 11 < 2 ? 0 : 11 - soma % 11;
      if (resultado != digitos.charAt(0)) return false;
      
      tamanho = tamanho + 1;
      numeros = cnpj.substring(0, tamanho);
      soma = 0;
      pos = tamanho - 7;
      
      for (let i = tamanho; i >= 1; i--) {
        soma += numeros.charAt(tamanho - i) * pos--;
        if (pos < 2) pos = 9;
      }
      
      resultado = soma % 11 < 2 ? 0 : 11 - soma % 11;
      if (resultado != digitos.charAt(1)) return false;
      
      return true;
    }

    // Placa Mercosul (AAA-0A00)
    function maskPlaca(value) {
      value = value.toUpperCase().replace(/[^A-Z0-9]/g,'').substring(0,7);
      // Formata como LLLNLNN
      if (value.length >= 3) value = value.slice(0,3) + '-' + value.slice(3);
      return value;
    }

    // Validação de Placa (formato antigo ABC-1234 ou Mercosul ABC-1D23)
    function validarPlaca(placa) {
      placa = placa.replace(/[^A-Z0-9]/g, '').toUpperCase();
      
      if (placa.length !== 7) return false;
      
      // Bloquear sequências repetidas
      if (/^(\w)\1{6}$/.test(placa)) return false;
      
      // Validar formato: 3 letras + 4 caracteres (números ou letra no 4º)
      const formatoAntigo = /^[A-Z]{3}[0-9]{4}$/; // ABC1234
      const formatoMercosul = /^[A-Z]{3}[0-9][A-Z0-9][0-9]{2}$/; // ABC1D23
      
      return formatoAntigo.test(placa) || formatoMercosul.test(placa);
    }

    // Data: apenas dias úteis + hoje mínimo (mantém comportamento do seu HTML antigo)
    function isWeekday(dateString) {
      const date = new Date(dateString + 'T00:00:00');
      const day = date.getDay();
      return day !== 0 && day !== 6;
    }
    
    // Verifica se a data é válida para agendamento (dia útil + até dia 25)
    function isValidScheduleDate(dateString) {
      const date = new Date(dateString + 'T00:00:00');
      const day = date.getDay();
      const dayOfMonth = date.getDate();
      
      // Não permite finais de semana (0=domingo, 6=sábado)
      if (day === 0 || day === 6) return false;
      
      // Não permite agendamentos após o dia 25 do mês
      if (dayOfMonth > 25) return false;
      
      return true;
    }
    
    function getNextWeekday(date) {
      const next = new Date(date);
      next.setDate(next.getDate() + 1);
      while ([0,6].includes(next.getDay())) next.setDate(next.getDate() + 1);
      return next;
    }
    
    // Retorna a próxima data válida para agendamento
    function getNextValidDate(date, cdNome = null) {
      const next = new Date(date);
      
      // CD Lagoa Nova: não permite agendamento no mesmo dia (D+1 mínimo)
      if (cdNome === 'LagoaNova') {
        next.setDate(next.getDate() + 1);
      }
      // Outros CDs: permite agendamento no mesmo dia
      
      // Loop até encontrar uma data válida
      while (!isValidScheduleDate(formatDateToISO(next))) {
        next.setDate(next.getDate() + 1);
        
        // Se passar do dia 25, pular para o próximo mês
        if (next.getDate() > 25) {
          next.setMonth(next.getMonth() + 1);
          next.setDate(1);
        }
      }
      
      return next;
    }
    
    // Helper para formatar data em ISO (YYYY-MM-DD)
    function formatDateToISO(date) {
      const yyyy = date.getFullYear();
      const mm = String(date.getMonth() + 1).padStart(2, '0');
      const dd = String(date.getDate()).padStart(2, '0');
      return `${yyyy}-${mm}-${dd}`;
    }
    
    // Gera lista de datas inválidas para desabilitar no input de data
    function getDisabledDates() {
      const disabled = [];
      const today = new Date();
      const endDate = new Date();
      endDate.setFullYear(today.getFullYear() + 1); // Até 1 ano à frente
      
      let current = new Date(today);
      while (current <= endDate) {
        const dateStr = formatDateToISO(current);
        if (!isValidScheduleDate(dateStr)) {
          disabled.push(dateStr);
        }
        current.setDate(current.getDate() + 1);
      }
      
      return disabled;
    }

    document.addEventListener('DOMContentLoaded', function() {
      function removeNF(btn) {
        const nfDiv = btn.closest('.nota-fiscal-item');
        if (nfDiv && document.querySelectorAll('.nota-fiscal-item').length > 1) {
          nfDiv.remove();
          calcularTotalUI();
        }
      }

      // Telefone do Motorista
      const phoneMotoristaInput = document.getElementById('telefone-motorista');
      if (phoneMotoristaInput) phoneMotoristaInput.addEventListener('input', (e)=> {
        e.target.value = maskPhone(e.target.value);
        e.target.setSelectionRange(e.target.value.length, e.target.value.length);
      });

      // Telefone
      const phoneInput = document.getElementById('telefone');
      if (phoneInput) phoneInput.addEventListener('input', (e)=> {
        e.target.value = maskPhone(e.target.value);
        e.target.setSelectionRange(e.target.value.length, e.target.value.length);
      });

      // CNPJ
      const docInput = document.getElementById('documento');
      if (docInput) {
        docInput.addEventListener('input', (e)=> {
          e.target.value = maskCNPJ(e.target.value);
          e.target.setSelectionRange(e.target.value.length, e.target.value.length);
        });
        
        docInput.addEventListener('blur', (e) => {
          const cnpj = e.target.value.replace(/\D/g, '');
          const feedback = e.target.parentElement.querySelector('.invalid-feedback') || 
                          (() => {
                            const div = document.createElement('div');
                            div.className = 'invalid-feedback hidden text-red-500 text-sm mt-1';
                            e.target.parentElement.appendChild(div);
                            return div;
                          })();
          
          if (cnpj.length === 14) {
            if (!validarCNPJ(cnpj)) {
              e.target.classList.add('border-red-500');
              feedback.textContent = '❌ CNPJ inválido. Verifique os dados informados.';
              feedback.classList.remove('hidden');
              e.target.setCustomValidity('CNPJ inválido');
            } else {
              e.target.classList.remove('border-red-500');
              feedback.classList.add('hidden');
              e.target.setCustomValidity('');
            }
          }
        });
      }

      // CPF Motorista
      const cpfInput = document.getElementById('cpf-motorista');
      if (cpfInput) {
        cpfInput.addEventListener('input', (e)=> {
          e.target.value = maskCPF(e.target.value);
          e.target.setSelectionRange(e.target.value.length, e.target.value.length);
        });
        
        cpfInput.addEventListener('blur', (e) => {
          const cpf = e.target.value.replace(/\D/g, '');
          const feedback = e.target.parentElement.querySelector('.invalid-feedback') || 
                          (() => {
                            const div = document.createElement('div');
                            div.className = 'invalid-feedback hidden text-red-500 text-sm mt-1';
                            e.target.parentElement.appendChild(div);
                            return div;
                          })();
          
          if (cpf.length === 11) {
            if (!validarCPF(cpf)) {
              e.target.classList.add('border-red-500');
              feedback.textContent = '❌ CPF inválido. Verifique os dados informados.';
              feedback.classList.remove('hidden');
              e.target.setCustomValidity('CPF inválido');
            } else {
              e.target.classList.remove('border-red-500');
              feedback.classList.add('hidden');
              e.target.setCustomValidity('');
            }
          }
        });
      }

      // Placa Veículo
      const placaInput = document.getElementById('placa-veiculo');
      if (placaInput) {
        placaInput.addEventListener('input', (e)=> {
          e.target.value = maskPlaca(e.target.value);
          e.target.setSelectionRange(e.target.value.length, e.target.value.length);
        });
        
        placaInput.addEventListener('blur', (e) => {
          const placa = e.target.value.replace(/[^A-Z0-9]/g, '');
          const feedback = e.target.parentElement.querySelector('.invalid-feedback') || 
                          (() => {
                            const div = document.createElement('div');
                            div.className = 'invalid-feedback hidden text-red-500 text-sm mt-1';
                            e.target.parentElement.appendChild(div);
                            return div;
                          })();
          
          if (placa.length === 7) {
            if (!validarPlaca(placa)) {
              e.target.classList.add('border-red-500');
              feedback.textContent = '❌ Placa inválida. Use formato ABC-1234 ou ABC-1D23.';
              feedback.classList.remove('hidden');
              e.target.setCustomValidity('Placa inválida');
            } else {
              e.target.classList.remove('border-red-500');
              feedback.classList.add('hidden');
              e.target.setCustomValidity('');
            }
          }
        });
      }

      // Validação de Número do Pedido
      function validarNumeroPedido(input) {
        const valor = input.value.trim();
        let mensagemErro = '';
        
        // Remover mensagem de erro anterior
        const erroExistente = input.parentElement.querySelector('.erro-pedido');
        if (erroExistente) {
          erroExistente.remove();
        }
        
        input.classList.remove('border-red-500');
        
        // Se estiver vazio, não mostrar erro (required vai cuidar)
        if (valor === '') {
          return true;
        }
        
        // Verificar se tem espaços
        if (/\s/.test(valor)) {
          mensagemErro = '❌ O número do pedido não pode conter espaços';
        }
        // Verificar se tem símbolos
        else if (/[^0-9]/.test(valor)) {
          mensagemErro = '❌ O número do pedido não pode conter símbolos ou letras';
        }
        // Verificar se não começa com 450
        else if (valor.length >= 3 && !valor.startsWith('450')) {
          mensagemErro = '❌ O número do pedido deve começar com 450';
        }
        // Verificar tamanho correto
        else if (valor.length > 0 && valor.length < 10) {
          mensagemErro = '⚠️ O número do pedido deve ter exatamente 10 dígitos (Ex: 4501234567)';
        }
        // Verificar formato completo
        else if (valor.length === 10 && !/^450[0-9]{7}$/.test(valor)) {
          mensagemErro = '❌ Formato inválido. O pedido deve começar com 450 seguido de 7 números';
        }
        
        // Mostrar mensagem de erro se houver
        if (mensagemErro) {
          input.classList.add('border-red-500');
          const divErro = document.createElement('div');
          divErro.className = 'erro-pedido text-red-500 text-sm mt-1 font-semibold';
          divErro.textContent = mensagemErro;
          input.parentElement.appendChild(divErro);
          return false;
        }
        
        // Sucesso - mostrar feedback positivo
        if (valor.length === 10) {
          input.classList.add('border-green-500');
        }
        
        return true;
      }
      
      // Adicionar validação em todos os campos de número do pedido
      function aplicarValidacaoPedidos() {
        const inputsPedido = document.querySelectorAll('input[name="numeroPedidoLinha"]');
        inputsPedido.forEach(input => {
          // Validar ao digitar
          input.addEventListener('input', (e) => {
            // Remover qualquer caractere que não seja número
            e.target.value = e.target.value.replace(/[^0-9]/g, '');
            validarNumeroPedido(e.target);
          });
          
          // Validar ao sair do campo
          input.addEventListener('blur', (e) => {
            validarNumeroPedido(e.target);
          });
          
          // Prevenir colar texto com símbolos/espaços
          input.addEventListener('paste', (e) => {
            e.preventDefault();
            const texto = (e.clipboardData || window.clipboardData).getData('text');
            const apenasNumeros = texto.replace(/[^0-9]/g, '');
            e.target.value = apenasNumeros.substring(0, 10);
            validarNumeroPedido(e.target);
          });
        });
      }
      
      // Aplicar validação inicial
      aplicarValidacaoPedidos();
      
      // Re-aplicar validação quando adicionar nova NF
      const observer = new MutationObserver(() => {
        aplicarValidacaoPedidos();
      });
      
      const containerNFs = document.getElementById('notas-fiscais-container');
      if (containerNFs) {
        observer.observe(containerNFs, { childList: true, subtree: true });
      }

      // Data mínima e impedir finais de semana + dias após 25
      const dataInput = document.getElementById('data-entrega');
      if (dataInput) {
        let today = new Date();
        
        // Função para atualizar data mínima baseada no CD selecionado
        function atualizarDataMinima() {
          const cdInput = document.getElementById('cd-destino');
          const subcategoriaInput = document.getElementById('subcategoria-cd');
          let cdNome = cdInput?.value;
          
          // Se for Ceará, verificar subcategoria
          if (cdNome === 'Ceará' && subcategoriaInput?.value) {
            cdNome = subcategoriaInput.value;
          }
          
          const nextValid = getNextValidDate(new Date(), cdNome);
          const minDate = formatDateToISO(nextValid);
          dataInput.setAttribute('min', minDate);
          
          // Se data atual for menor que a mínima, atualizar para a mínima
          if (dataInput.value && dataInput.value < minDate) {
            const oldDate = dataInput.value;
            dataInput.value = minDate;
            if (cdNome === 'LagoaNova') {
              alert('⚠️ CD LAGOA NOVA (SEDE) não permite agendamento no mesmo dia. Data ajustada para o próximo dia útil disponível.');
            }
          }
          
          // Atualizar tooltip
          if (cdNome === 'LagoaNova') {
            dataInput.setAttribute('title', 'CD LAGOA NOVA (SEDE): agendamento somente a partir do próximo dia útil (seg-sex) até o dia 25');
          } else {
            dataInput.setAttribute('title', 'Selecione apenas dias úteis (seg-sex) até o dia 25 de cada mês');
          }
        }
        
        // Define data mínima inicial
        const nextValid = getNextValidDate(today);
        const minDate = formatDateToISO(nextValid);
        dataInput.setAttribute('min', minDate);
        
        // Define valor padrão como próxima data válida
        dataInput.value = minDate;
        
        // Adiciona tooltip informativo inicial
        dataInput.setAttribute('title', 'Selecione apenas dias úteis (seg-sex) até o dia 25 de cada mês');
        
        // Adicionar listeners para atualizar data quando CD mudar
        const cdInput = document.getElementById('cd-destino');
        const subcategoriaInput = document.getElementById('subcategoria-cd');
        if (cdInput) {
          cdInput.addEventListener('change', atualizarDataMinima);
        }
        if (subcategoriaInput) {
          subcategoriaInput.addEventListener('change', atualizarDataMinima);
        }

        dataInput.addEventListener('change', function() {
          if (!isValidScheduleDate(this.value)) {
            const selectedDate = new Date(this.value + 'T00:00:00');
            const dayOfMonth = selectedDate.getDate();
            
            let message = '';
            if (dayOfMonth > 25) {
              message = 'Não é possível agendar entregas após o dia 25 do mês. Selecionando próxima data disponível...';
            } else if (!isWeekday(this.value)) {
              message = 'Por favor, selecione apenas dias úteis (segunda a sexta-feira). Selecionando próxima data disponível...';
            }
            
            if (message) {
              alert(message);
              const nextValid = getNextValidDate(selectedDate);
              this.value = formatDateToISO(nextValid);
            }
          }
        });
        
        // Bloqueia a digitação manual de datas inválidas
        dataInput.addEventListener('keydown', function(e) {
          // Permite apenas navegação, não digitação manual
          if (!['Tab', 'Escape', 'Enter'].includes(e.key)) {
            e.preventDefault();
          }
        });
      }

      // Notas: máscara de dinheiro + ícone de arquivo
      function maskMoneyInput(input) {
        // Aceita apenas dígitos e vírgula, bloqueia letras e múltiplos separadores
        let value = input.value.replace(/[^\d,]/g, '');
        // Permite apenas uma vírgula
        const parts = value.split(',');
        if (parts.length > 2) value = parts[0] + ',' + parts[1];
        
        // Limita a duas casas decimais
        if (parts[1] && parts[1].length > 2) {
          value = parts[0] + ',' + parts[1].substring(0, 2);
        }

        // Adiciona "R$ " e formatação de milhar no blur
        if (value) {
            let num = parseFloat(value.replace(',', '.'));
            if (!isNaN(num)) {
                input.value = 'R$ ' + num.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
            } else {
                input.value = 'R$ 0,00';
            }
        } else {
            input.value = 'R$ 0,00';
        }
      }
      
      function formatMoneyOnInput(input) {
          let value = input.value.replace(/\D/g, ''); // Remove tudo que não é dígito
          
          if (value === "") {
              input.value = ""; // Permite apagar
              return;
          }

          // Remove zeros à esquerda
          value = value.replace(/^0+/, '');

          if (value.length === 0) {
            input.value = 'R$ 0,00';
          } else if (value.length === 1) {
            input.value = 'R$ 0,0' + value;
          } else if (value.length === 2) {
            input.value = 'R$ 0,' + value;
          } else {
            let intPart = value.substring(0, value.length - 2);
            let decPart = value.substring(value.length - 2);
            
            // Adiciona pontos de milhar
            intPart = intPart.replace(/\B(?=(\d{3})+(?!\d))/g, '.');
            
            input.value = 'R$ ' + intPart + ',' + decPart;
          }
          
          // Move o cursor para o final
          if (typeof input.selectionStart === 'number') {
            input.setSelectionRange(input.value.length, input.value.length);
          }
      }

      function calcularTotalUI() {
        const valores = document.querySelectorAll('#notas-container [name="valorNF"]');
        let total = 0;
        valores.forEach(inp => {
          let raw = inp.value || '';
          // Remove prefixo, espaços, pontos, deixa só número e vírgula
          raw = raw.replace(/R\$|\s|\./g, '');
          // Troca vírgula por ponto
          raw = raw.replace(',', '.');
          let num = parseFloat(raw);
          if (isFinite(num) && !isNaN(num)) total += num;
        });
        document.getElementById('total-geral-nf').textContent =
          'R$ ' + total.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
      }

      // Função de setup para cada linha de NF (MODIFICADA)
      function setupNota(notaDiv) {
        const valor = notaDiv.querySelector('[name="valorNF"]');
        const file = notaDiv.querySelector('[name="arquivoNF"]');
        const fileLabel = notaDiv.querySelector('.file-input-label');
        const fileNameSpan = notaDiv.querySelector('span.file-name');
        const defaultFileName = "Clique para anexar PDF";

        if (valor) {
          valor.addEventListener('input', (e) => formatMoneyOnInput(e.target));
          valor.addEventListener('blur', (e) => {
            maskMoneyInput(e.target);
            calcularTotalUI();
          });
        }
        
        if (file && fileLabel && fileNameSpan) {
            file.addEventListener('change', () => {
            if (file.files.length > 0) {
                fileNameSpan.textContent = file.files[0].name;
                fileLabel.classList.add('file-selected');
            } else {
                fileNameSpan.textContent = defaultFileName;
                fileLabel.classList.remove('file-selected');
            }
            });
        }
      }

      // Primeira linha de NF
      setupNota(document.querySelector('.nota-fiscal-item'));
      
      // Exibe lixeira nas linhas extras
      function updateRemoveButtons() {
        const nfItems = document.querySelectorAll('.nota-fiscal-item');
        nfItems.forEach((item, idx) => {
          const btn = item.querySelector('.btn-remove-nf');
          if (btn) {
            btn.style.display = nfItems.length > 1 ? '' : 'flex'; // 'flex' para alinhar icone
            btn.onclick = () => removeNF(btn);
          }
        });
      }
      updateRemoveButtons();

      // Botão de adicionar NF
      const addNFBtn = document.getElementById('btn-add-nf');
      if (addNFBtn) {
        addNFBtn.addEventListener('click', () => {
          const tmpl = document.querySelector('.nota-fiscal-item');
          const clone = tmpl.cloneNode(true);
          // limpar valores
          clone.querySelectorAll('input').forEach(i => { i.value = ''; });
          
          // Resetar o label do arquivo
          const fileLabel = clone.querySelector('.file-input-label');
          const fileNameSpan = clone.querySelector('span.file-name');
          if(fileNameSpan) fileNameSpan.textContent = "Clique para anexar PDF";
          if(fileLabel) fileLabel.classList.remove('file-selected');

          document.getElementById('notas-container').appendChild(clone);
          setupNota(clone);
          updateRemoveButtons();
        });
      }
    });

    // Regra de bloqueio automático (usada pelo backend/validador ou exibida ao usuário)
    function calcularTempoDescarregamento(qtd, tipo) {
      let horas = 1;
      if (['palet','bloco','tambor'].includes(String(tipo).toLowerCase())) {
        if (qtd > 3 && qtd <= 6) horas = 2;
        else if (qtd > 6) horas = 3;
      }
      return horas;
    }
  </script>

    <script src="js/agendamento.js"></script>
    <script>
      document.addEventListener('DOMContentLoaded', function() {
        // Flatpickr com formato brasileiro e idioma pt
        if (window.flatpickr) {
          // Carrega locale pt-BR se disponível
          if (window.flatpickr && window.flatpickr.l10ns && window.flatpickr.l10ns.pt) {
            // já está disponível
          } else {
            // Carrega locale pt.js dinamicamente se necessário
            var script = document.createElement('script');
            script.src = 'https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/pt.js';
            document.head.appendChild(script);
          }
          flatpickr("#data-entrega", {
            dateFormat: "d/m/Y",
            locale: "pt",
            allowInput: true,
            disableMobile: true,
            minDate: "today",
            disable: [
              function(date) {
                // Desabilita sábados (6) e domingos (0)
                return (date.getDay() === 0 || date.getDay() === 6);
              }
            ],
            // minDate e maxDate também podem ser setados dinamicamente pelo JS já existente
            onChange: function(selectedDates, dateStr, instance) {
              // Dispara evento 'change' para integração com JS existente
              const event = new Event('change', { bubbles: true });
              instance._input.dispatchEvent(event);
            }
          });
        }
      });
    </script>
  <script>
    window.addEventListener('DOMContentLoaded', function() {
      setTimeout(function() {
        const overlay = document.getElementById('page-transition');
        overlay.style.opacity = '0';
        overlay.style.pointerEvents = 'none';
      }, 400);
      document.getElementById('btn-voltar').addEventListener('click', function(e) {
        e.preventDefault();
        const overlay = document.getElementById('page-transition');
        overlay.style.pointerEvents = 'auto';
        overlay.style.opacity = '1';
        setTimeout(function() {
          window.location.href = '/';
        }, 500);
      });
    });
  </script>
</body>
</html>